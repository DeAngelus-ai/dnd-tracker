<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Encounter Builder & Tracker - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@300;400;600;700;900&display=swap');
        
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #2b2b4d;
            --bg-tertiary: #3b3b60;
            --accent-gold: #e0b44b;
            --accent-gold-light: #f0c35e;
            --text-primary: #e4e4e7;
            --text-secondary: #c9c9e0;
            --border-color: #4a4a6e;
        }
        
        [data-theme="blood"] {
            --bg-primary: #1a0a0a;
            --bg-secondary: #2d1515;
            --bg-tertiary: #4a2020;
            --accent-gold: #dc2626;
            --accent-gold-light: #ef4444;
            --text-primary: #fecaca;
            --text-secondary: #fca5a5;
            --border-color: #7f1d1d;
        }
        
        [data-theme="arcane"] {
            --bg-primary: #0f0a1a;
            --bg-secondary: #1a1535;
            --bg-tertiary: #2d2550;
            --accent-gold: #8b5cf6;
            --accent-gold-light: #a78bfa;
            --text-primary: #e9d5ff;
            --text-secondary: #d8b4fe;
            --border-color: #6b21a8;
        }
        
        [data-theme="nature"] {
            --bg-primary: #0a1a0a;
            --bg-secondary: #152d15;
            --bg-tertiary: #204a20;
            --accent-gold: #22c55e;
            --accent-gold-light: #4ade80;
            --text-primary: #dcfce7;
            --text-secondary: #bbf7d0;
            --border-color: #166534;
        }
        
        [data-theme="gray"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --accent-gold: #9ca3af;
            --accent-gold-light: #d1d5db;
            --text-primary: #e5e7eb;
            --text-secondary: #d1d5db;
            --border-color: #6b7280;
        }
        
        [data-theme="black"] {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #1a1a1a;
            --accent-gold: #ffffff;
            --accent-gold-light: #f3f4f6;
            --text-primary: #ffffff;
            --text-secondary: #e5e7eb;
            --border-color: #374151;
        }
        
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-gold) var(--bg-primary);
        }
        
        *::-webkit-scrollbar {
            width: 10px;
        }
        
        *::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        *::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 5px;
        }
        
        *::-webkit-scrollbar-thumb:hover {
            background: var(--accent-gold-light);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 16px;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(224, 180, 75, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(224, 180, 75, 0.03) 0%, transparent 50%);
            background-attachment: fixed;
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
        }
        
        h1, h2, h3 {
            font-family: 'Cinzel', serif;
            color: var(--accent-gold);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .container-card {
            background-color: var(--bg-secondary);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            padding: 30px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .container-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
            opacity: 0.5;
        }
        
        .input-group label {
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        input[type="number"],
        input[type="text"],
        select {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 2px rgba(224, 180, 75, 0.2);
        }
        
        .btn-generate {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
            color: var(--bg-primary);
            font-weight: 700;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .btn-generate::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-generate:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(224, 180, 75, 0.4);
        }
        
        .btn-upload {
            background-color: var(--border-color);
            color: var(--accent-gold);
            font-weight: 700;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .btn-upload:hover {
            background-color: var(--bg-tertiary);
            box-shadow: 0 4px 12px rgba(224, 180, 75, 0.2);
            transform: translateY(-1px);
        }
        
        .result-box {
            background-color: var(--bg-primary);
            border: 2px solid var(--accent-gold);
            padding: 20px;
            border-radius: 0.75rem;
            position: relative;
            overflow: hidden;
        }
        
        .result-box::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--accent-gold), transparent, var(--accent-gold));
            z-index: -1;
            filter: blur(10px);
            opacity: 0.3;
        }
        
        /* Responsive Grid for Reward Trackers (XP & Loot) */
        .reward-trackers-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        
        /* Side-by-side on tablets and larger */
        @media (min-width: 768px) {
            .reward-trackers-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Ensure both boxes have equal height on desktop */
        @media (min-width: 768px) {
            .reward-trackers-grid > .result-box {
                display: flex;
                flex-direction: column;
            }
            
            .reward-trackers-grid > .result-box > div:last-child {
                flex-grow: 1;
            }
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 0;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
            transition: background-color 0.2s;
        }
        
        th {
            background-color: var(--border-color);
            color: var(--accent-gold);
            font-family: 'Cinzel', serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.85rem;
        }
        
        td {
            background-color: var(--bg-tertiary);
        }
        
        tbody tr:hover td {
            background-color: rgba(224, 180, 75, 0.1);
        }
        
        .difficulty-low { color: #50fa7b; }
        .difficulty-moderate { color: #ffb86c; }
        .difficulty-high { color: #ff5555; }
        
        .monster-list {
            list-style-type: none;
            padding-left: 0;
        }
        
        .monster-list li {
            background-color: var(--bg-tertiary);
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 0.5rem;
            border-left: 4px solid var(--accent-gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .monster-list li:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(224, 180, 75, 0.3);
        }
        
        .monster-info { flex-grow: 1; }
        
        .hp-bar-container {
            height: 12px;
            background-color: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 6px;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .hp-bar {
            height: 100%;
            transition: width 0.4s ease-in-out, background-color 0.4s;
            position: relative;
        }
        
        @keyframes shimmer {
            0% { background-position: -50px 0; }
            100% { background-position: 150px 0; }
        }
        
        .hp-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
            background-size: 50px 100%;
            animation: shimmer 2s infinite linear;
        }
        
        .temp-hp-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            opacity: 0.7;
            z-index: 1;
            transition: width 0.3s ease-in-out;
        }
        
        .current-turn-highlight td {
            background-color: #44446a !important;
            border-left: 4px solid var(--accent-gold-light);
            border-right: 4px solid var(--accent-gold-light);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(240, 195, 94, 0); }
            50% { box-shadow: 0 0 20px 5px rgba(240, 195, 94, 0.3); }
        }
        
        .current-turn-highlight td:first-child {
            border-radius: 0.5rem 0 0 0.5rem;
        }
        
        .current-turn-highlight td:last-child {
            border-radius: 0 0.5rem 0.5rem 0;
        }
        
        .damage-number {
            position: fixed;
            font-size: 1.5rem;
            font-weight: 900;
            pointer-events: none;
            z-index: 1000;
            animation: floatUp 1.5s ease-out forwards;
            text-shadow: 0 0 10px currentColor, 0 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.5);
            }
        }
        
        .damage-number.damage { color: #ef4444; }
        .damage-number.heal { color: #22c55e; }
        
        .bloodied-icon {
            color: #ef4444;
            animation: pulse-blood 1s infinite;
            margin-left: 8px;
        }
        
        @keyframes pulse-blood {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .death-saves {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            align-items: center;
        }
        
        .death-save-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .death-save-dot:hover {
            transform: scale(1.2);
        }
        
        .death-save-dot.success {
            background: #22c55e;
            border-color: #22c55e;
            box-shadow: 0 0 8px #22c55e;
        }
        
        .death-save-dot.failure {
            background: #ef4444;
            border-color: #ef4444;
            box-shadow: 0 0 8px #ef4444;
        }
        
        /* ==================== TAB NAVIGATION ==================== */
        .tab-navigation {
            display: flex;
            gap: 0;
            background: var(--bg-secondary);
            border-radius: 1rem 1rem 0 0;
            padding: 0;
            margin: 2rem auto 0;
            max-width: 1400px;
            border: 2px solid var(--border-color);
            border-bottom: none;
            overflow: hidden;
        }
        
        .tab-button {
            flex: 1;
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            border-right: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .tab-button:last-child {
            border-right: none;
        }
        
        .tab-button:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .tab-button.active {
            background: var(--bg-primary);
            color: var(--accent-gold);
            border-bottom: 3px solid var(--accent-gold);
        }
        
        .tab-button i {
            font-size: 1.2rem;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-container {
            border: 2px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 1rem 1rem;
            background: var(--bg-secondary);
            padding: 2rem;
            margin: 0 auto;
            max-width: 1400px;
        }
        
        /* Two-Column Layout for Combat Tab Setup */
        .combat-setup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
            align-items: start;
        }
        
        /* Two-Column Layout for Setup Tab */
        .setup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
            align-items: start;
        }
        
        @media (max-width: 768px) {
            .combat-setup-grid,
            .setup-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .tab-button {
                padding: 0.75rem 0.5rem;
                font-size: 0.875rem;
                flex-direction: column;
                gap: 0.25rem;
            }
            
            .tab-button i {
                font-size: 1rem;
            }
        }
        
        .floating-dice-roller {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--accent-gold);
            border-radius: 1rem;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 900;
            min-width: 200px;
            transition: all 0.3s;
            resize: both;
            overflow: auto;
        }
        
        .floating-dice-roller.collapsed {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            min-width: unset;
            resize: none;
        }
        
        .ai-assistant-panel {
            position: fixed;
            bottom: 20px;
            right: 320px;
            background: var(--bg-secondary);
            border: 2px solid #8b5cf6;
            border-radius: 1rem;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 899;
            min-width: 300px;
            transition: all 0.3s;
            resize: both;
            overflow: auto;
        }
        
        .ai-assistant-panel.collapsed {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            min-width: unset;
            resize: none;
        }
        
        .multiplayer-panel {
            position: fixed;
            bottom: 20px;
            right: 640px;
            background: var(--bg-secondary);
            border: 2px solid #3b82f6;
            border-radius: 1rem;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 898;
            min-width: 300px;
            transition: all 0.3s;
            resize: both;
            overflow: auto;
        }
        
        .multiplayer-panel.collapsed {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            min-width: unset;
            resize: none;
        }
        
        
        .panel-header {
            cursor: move;
            user-select: none;
        }
        
        .panel-header:active {
            cursor: grabbing;
        }
        
        .dragging {
            opacity: 0.8;
            transition: none !important;
        }
        
        .resizing {
            transition: none !important;
        }
        
        /* Resize handle styling */
        .floating-dice-roller:not(.collapsed)::after,
        .ai-assistant-panel:not(.collapsed)::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, var(--border-color) 50%);
            border-bottom-right-radius: 0.75rem;
        }
        
        #dice-roller-collapsed, #ai-assistant-collapsed {
            cursor: move; /* Show it's draggable */
            transition: transform 0.2s;
        }
        
        #dice-roller-collapsed:hover, #ai-assistant-collapsed:hover {
            transform: scale(1.1);
        }
        
        .dice-button {
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .dice-button:hover {
            background: var(--accent-gold);
            color: var(--bg-primary);
            transform: scale(1.1);
        }
        
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 800;
            background: var(--bg-secondary);
            padding: 12px 20px;
            border-radius: 0.5rem;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--accent-gold);
        }
        
        .sticky-header.visible {
            display: flex;
        }
        
        .dice-history {
            position: fixed;
            right: 20px;
            bottom: 100px;
            width: 250px;
            max-height: 300px;
            background: var(--bg-secondary);
            border: 2px solid var(--accent-gold);
            border-radius: 0.75rem;
            padding: 12px;
            overflow-y: auto;
            z-index: 850;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .dice-history.visible {
            display: block;
        }
        
        .dice-history-item {
            padding: 8px;
            margin-bottom: 6px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .xp-progress-container {
            width: 100%;
            height: 30px;
            background: var(--bg-primary);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin-top: 10px;
            border: 2px solid var(--border-color);
        }
        
        .xp-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
            transition: width 0.5s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        
        .xp-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        .xp-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            z-index: 1;
            font-size: 0.9rem;
        }
        
        .combatant-notes {
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-style: italic;
            padding: 4px 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            border-left: 2px solid var(--accent-gold);
        }
        
        .theme-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 8px;
            flex-direction: column;
        }
        
        .theme-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .theme-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
        }
        
        .theme-button.active {
            border-color: white;
            box-shadow: 0 0 20px currentColor;
        }
        
        .theme-default { background: linear-gradient(135deg, #1a1a2e, #e0b44b); }
        .theme-blood { background: linear-gradient(135deg, #1a0a0a, #dc2626); }
        .theme-arcane { background: linear-gradient(135deg, #0f0a1a, #8b5cf6); }
        .theme-nature { background: linear-gradient(135deg, #0a1a0a, #22c55e); }
        .theme-gray { background: linear-gradient(135deg, #1a1a1a, #9ca3af); }
        .theme-black { background: linear-gradient(135deg, #000000, #ffffff); }
        
        .stat-block-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .stat-block-content {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 25px;
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 3px solid var(--accent-gold);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            position: relative;
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .stat-block-content h3 {
            color: var(--accent-gold);
            font-size: 1.8rem;
            border-bottom: 2px solid var(--accent-gold);
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        
        .stat-block-content strong {
            color: var(--accent-gold-light);
        }
        
        .attack-link {
            font-weight: bold;
            color: var(--accent-gold-light);
            cursor: pointer;
            text-decoration: none;
            transition: color 0.15s;
            border-bottom: 2px solid transparent;
        }
        
        .attack-link:hover {
            color: var(--accent-gold);
            border-bottom: 2px solid var(--accent-gold);
        }
        
        #modal-damage-output {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--bg-primary);
            border-radius: 0.5rem;
            border: 2px solid #50fa7b;
            min-height: 40px;
        }
        
        .result-box-roll {
            background-color: var(--bg-primary);
            border-radius: 0.5rem;
            padding: 15px;
            text-align: center;
        }
        
        #modal-damage-result {
            font-size: 3rem;
            font-weight: 900;
            color: #50fa7b;
            text-shadow: 0 0 10px rgba(80, 250, 123, 0.5);
        }
        
        #modal-to-hit-result {
            font-size: 3rem;
            font-weight: 900;
            color: #ffb86c;
            text-shadow: 0 0 10px rgba(255, 184, 108, 0.5);
        }
        
        .stat-line-container {
            border-left: 3px solid var(--bg-tertiary);
            padding-left: 10px;
            margin-top: 8px;
        }
        
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 0.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1100;
            animation: slideInRight 0.3s;
            max-width: 300px;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @media print {
            .theme-selector,
            .floating-dice-roller,
            .dice-history,
            .btn-generate,
            .btn-upload,
            .btn-add-player,
            button {
                display: none !important;
            }
            
            body {
                background: white;
                color: black;
            }
            
            .container-card {
                break-inside: avoid;
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }
        
        @media (max-width: 768px) {
            .container-card {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.75rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .stat-block-content {
                max-height: 80vh;
            }
            
            .floating-dice-roller {
                bottom: 10px;
                right: 10px;
            }
            
            .ai-assistant-panel {
                bottom: 120px;
                right: 10px;
                left: 10px;
                width: auto;
                min-width: unset;
            }
            
            .theme-selector {
                top: 10px;
                right: 10px;
            }
            
            .theme-button {
                width: 35px;
                height: 35px;
            }
            
            table {
                font-size: 0.85rem;
            }
            
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Selector -->
    <div class="theme-selector">
        <button class="theme-button theme-default active" onclick="setTheme('default')" title="Default Theme" aria-label="Default Theme"></button>
        <button class="theme-button theme-blood" onclick="setTheme('blood')" title="Blood Spatter" aria-label="Blood Spatter Theme"></button>
        <button class="theme-button theme-arcane" onclick="setTheme('arcane')" title="Arcane" aria-label="Arcane Theme"></button>
        <button class="theme-button theme-nature" onclick="setTheme('nature')" title="Nature" aria-label="Nature Theme"></button>
        <button class="theme-button theme-gray" onclick="setTheme('gray')" title="Gray" aria-label="Gray Theme"></button>
        <button class="theme-button theme-black" onclick="setTheme('black')" title="Black" aria-label="Black Theme"></button>
    </div>
    
    <!-- Panel Controls (Temporary Debug) -->
    <div style="position: fixed; top: 10px; right: 150px; z-index: 9999; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px;">
        <button onclick="resetPanelPositions()" style="padding: 5px 10px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
            Reset Panels
        </button>
    </div>

    <!-- Sticky Header -->
    <div class="sticky-header" id="sticky-header">
        <div class="flex items-center gap-4">
            <i class="fas fa-dice-d20 fa-lg"></i>
            <div>
                <div class="font-bold" id="sticky-current-turn">-</div>
                <div class="text-xs text-gray-400">Round <span id="sticky-round">-</span></div>
            </div>
        </div>
    </div>

    <div class="w-full max-w-4xl mx-auto p-4 md:p-8">
        <h1 class="text-4xl text-center mb-6">
            <i class="fas fa-dragon mr-3"></i>
            The DM's Enhanced Encounter Builder & Tracker
            <i class="fas fa-dice-d20 ml-3"></i>
        </h1>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" onclick="switchTab('setup')" id="tab-setup">
            <i class="fas fa-cog"></i>
            <span>Setup</span>
        </button>
        <button class="tab-button" onclick="switchTab('combat')" id="tab-combat">
            <i class="fas fa-swords"></i>
            <span>Combat</span>
        </button>
        <button class="tab-button" onclick="switchTab('notes')" id="tab-notes">
            <i class="fas fa-sticky-note"></i>
            <span>Notes</span>
        </button>
        <button class="tab-button" onclick="switchTab('dice')" id="tab-dice">
            <i class="fas fa-dice-d20"></i>
            <span>Dice</span>
        </button>
    </div>

    <!-- Tab Container -->
    <div class="tab-container">
        
        <!-- ==================== SETUP TAB ==================== -->
        <div class="tab-content active" id="content-setup">
            <div class="container-card" style="border: none; padding: 0;">
                
            <!-- Two-Column Grid Container -->
            <div class="setup-grid">
                <!-- LEFT COLUMN: Load Monster Data & Party Setup -->
                <div>
                    <h2 class="text-2xl mb-4">
                        <i class="fas fa-upload mr-2"></i>
                        1. Load Monster Data
                    </h2>
                    <div class="input-group mb-6">
                        <label for="json-upload" class="w-full btn-upload p-3 rounded-xl text-center block cursor-pointer">
                            <i class="fas fa-file-import mr-2"></i>
                            Upload Monster JSON
                        </label>
                        <input type="file" id="json-upload" accept=".json" class="hidden">
                    </div>

                    <h2 class="text-2xl mb-4">
                        <i class="fas fa-users mr-2"></i>
                        2. Party & Difficulty
                    </h2>
                    <div class="space-y-4 mb-6">
                        <div class="input-group">
                            <label for="level" class="block mb-2">
                                <i class="fas fa-level-up-alt"></i>
                                Average Party Level (1-20)
                            </label>
                            <input type="number" id="level" min="1" max="20" value="3" class="w-full p-2 rounded-lg">
                        </div>
                        <div class="input-group">
                            <label for="players" class="block mb-2">
                                <i class="fas fa-user-friends"></i>
                                Number of Players (3-6)
                            </label>
                            <input type="number" id="players" min="3" max="6" value="4" class="w-full p-2 rounded-lg">
                        </div>
                        <div class="input-group">
                            <label for="difficulty" class="block mb-2">
                                <i class="fas fa-chart-line"></i>
                                Desired Difficulty
                            </label>
                            <select id="difficulty" class="w-full p-2 rounded-lg">
                                <option value="Low">Low (Easy)</option>
                                <option value="Moderate" selected>Moderate (Challenging)</option>
                                <option value="High">High (Deadly)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Monster Filter -->
                <div>
                    <h2 class="text-2xl mb-4">
                        <i class="fas fa-filter mr-2"></i>
                        3. Monster Filter
                    </h2>
                    
                    <!-- Monster Search Bar -->
                    <div class="input-group mb-4">
                        <label for="monster-search" class="block mb-2">
                            <i class="fas fa-search"></i>
                            Search Monsters by Name
                        </label>
                        <input 
                            type="text" 
                            id="monster-search" 
                            placeholder="Type monster name and press Enter..." 
                            class="w-full p-3 rounded-lg"
                            onkeydown="if(event.key === 'Enter') performMonsterSearch()"
                            style="background-color: var(--bg-primary); border: 2px solid var(--border-color); color: var(--text-primary);">
                        <div id="search-results-count" class="text-xs text-gray-400 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Type a monster name and press Enter to search
                        </div>
                    </div>
                    
                    <div class="input-group mb-4">
                        <label for="creature-type" class="block mb-2">
                            <i class="fas fa-paw"></i>
                            Filter by Type (Ctrl+Click for multiple)
                        </label>
                        <select id="creature-type" multiple size="5" class="w-full p-2 rounded-lg">
                            <option disabled>-- Upload a JSON file first --</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="cr-filter" class="block mb-2">
                            <i class="fas fa-skull-crossbones"></i>
                            Filter by CR (Ctrl+Click for multiple)
                        </label>
                        <select id="cr-filter" multiple size="5" class="w-full p-2 rounded-lg">
                            <option disabled>-- Upload a JSON file first --</option>
                        </select>
                    </div>
                </div>
            </div>
            <!-- End Two-Column Grid -->

            <!-- Full-Width Generate Button -->
            <button onclick="calculateEncounter()" class="w-full btn-generate p-3 rounded-xl uppercase tracking-wider mb-6">
                <i class="fas fa-magic mr-2"></i>
                Generate Encounter Suggestions
            </button>
        </div>

        <div id="results-container" class="container-card hidden">
            <h2 class="text-3xl text-center mb-6">
                <i class="fas fa-list-check mr-2"></i>
                Encounter Suggestions
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="result-box">
                    <h3 class="text-xl mb-3 text-center">
                        <i class="fas fa-star mr-2"></i>
                        XP Budget
                    </h3>
                    <p class="text-center text-lg">Target Difficulty: <span id="output-difficulty" class="font-bold difficulty-moderate"></span></p>
                    <p class="text-center text-3xl font-extrabold text-white"><span id="output-budget">0</span> XP</p>
                    <p class="text-xs text-center mt-2 text-gray-400">XP required to meet this challenge.</p>
                    <div class="xp-progress-container">
                        <div class="xp-progress-bar" id="xp-progress-bar" style="width: 0%"></div>
                        <div class="xp-progress-text" id="xp-progress-text">0%</div>
                    </div>
                </div>
                <div class="result-box">
                    <h3 class="text-xl mb-3 text-center">
                        <i class="fas fa-users mr-2"></i>
                        Party Details
                    </h3>
                    <p class="text-center text-lg">
                        <i class="fas fa-level-up-alt mr-1"></i>
                        Level: <span id="output-level" class="font-bold text-white"></span>
                    </p>
                    <p class="text-center text-lg">
                        <i class="fas fa-user-friends mr-1"></i>
                        Players: <span id="output-players" class="font-bold text-white"></span>
                    </p>
                    <p class="text-xs text-center mt-2 text-gray-400">Total XP/Player: <span id="output-xp-per"></span></p>
                </div>
            </div>
            <div class="result-box">
                <h3 class="text-xl mb-3">
                    <i class="fas fa-dragon mr-2"></i>
                    Monster Suggestions (<span id="output-filters" class="font-bold"></span>)
                </h3>
                <p class="text-sm mb-4 text-gray-300">
                    <i class="fas fa-info-circle mr-1"></i>
                    Choose a combination of these creatures to total your <span id="output-budget-2" class="font-bold"></span> XP budget. Click a name to view the stat block, or Add to Combat to track it!
                </p>
                <ul id="monster-suggestions" class="monster-list grid grid-cols-1 md:grid-cols-1 gap-3"></ul>
            </div>
        </div>
        <!-- End of Setup Tab -->
        </div>

        <!-- ==================== COMBAT TAB ==================== -->
        <div class="tab-content" id="content-combat">
            <div class="container-card" style="border: none; padding: 0;">
                <h2 class="text-3xl text-center mb-6">
                    <i class="fas fa-swords mr-2"></i>
                    Combat Tracker
                </h2>
            
            <!-- Two-Column Grid Container -->
            <div class="combat-setup-grid">
                <!-- LEFT COLUMN: Load & Save Encounter -->
                <div class="input-group">
                    <h3 class="text-xl mb-4" style="color: var(--accent-gold);">
                        <i class="fas fa-save mr-2"></i>
                        Load & Save Encounter
                    </h3>
                    <div class="mb-4">
                        <label for="encounter-name-input" class="block mb-2">
                            <i class="fas fa-tag mr-2"></i>
                            Encounter Name (Optional)
                        </label>
                        <input type="text" id="encounter-name-input" placeholder="e.g., Goblin Ambush" class="w-full p-2 rounded-lg">
                    </div>
                    <div class="grid grid-cols-1 gap-3">
                        <label for="encounter-upload" class="w-full btn-upload p-3 rounded-xl text-center block cursor-pointer">
                            <i class="fas fa-upload mr-2"></i>
                            Load Encounter File
                        </label>
                        <input type="file" id="encounter-upload" accept=".json" class="hidden">
                        <button onclick="saveEncounter()" class="p-3 bg-green-700 hover:bg-green-600 rounded-xl text-white font-bold transition-all">
                            <i class="fas fa-download mr-2"></i>
                            Save Current Encounter
                        </button>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Player Combatants Setup -->
                <div class="input-group">
                    <h3 class="text-xl mb-4" style="color: var(--accent-gold);">
                        <i class="fas fa-user-plus mr-2"></i>
                        Player Combatants Setup
                    </h3>
                    <div id="dynamic-player-inputs" class="space-y-4 mb-4"></div>
                    <button onclick="addPlayerSlot()" class="p-2 btn-add-player rounded-lg w-full bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-gray-900 font-bold">
                        <i class="fas fa-plus mr-2"></i>
                        Add New Player Slot
                    </button>
                </div>
            </div>
            <!-- End Two-Column Grid -->
            
            <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 mb-6">
                <button onclick="addPlayersToEncounter()" class="p-3 bg-indigo-700 hover:bg-indigo-600 rounded-lg text-white font-bold transition-all">
                    <i class="fas fa-users mr-2"></i>
                    1. Add Players
                </button>
                <button onclick="sortInitiative()" class="p-3 btn-generate rounded-lg uppercase tracking-wider">
                    <i class="fas fa-sort-amount-down mr-2"></i>
                    2. Sort
                </button>
                <button onclick="toggleQuickDicePanel()" class="p-3 bg-blue-700 hover:bg-blue-600 rounded-lg text-white font-bold transition-all">
                    <i class="fas fa-dice-d20 mr-2"></i>
                    Quick Dice
                </button>
                <button onclick="toggleTurnTimer()" class="p-3 bg-purple-700 hover:bg-purple-600 rounded-lg text-white font-bold transition-all">
                    <i class="fas fa-stopwatch mr-2"></i>
                    Turn Timer
                </button>
                <button onclick="clearEncounter()" class="p-3 bg-red-700 hover:bg-red-600 rounded-lg text-white font-bold transition-all">
                    <i class="fas fa-trash mr-2"></i>
                    Clear
                </button>
            </div>
            
            <div class="result-box mb-4">
                <h3 class="text-xl text-center">
                    <i class="fas fa-chart-bar mr-2"></i>
                    Current Encounter XP: 
                    <span id="current-xp-total" class="font-bold text-white">0</span> / 
                    <span id="budget-xp-total" class="font-bold" style="color: var(--accent-gold);">0</span>
                </h3>
            </div>

            <div class="result-box mb-4">
                <div class="flex justify-between items-center mb-2 flex-wrap gap-2">
                    <h3 class="text-xl" style="color: var(--accent-gold);">
                        <i class="fas fa-hourglass-half mr-2"></i>
                        Turn Tracker
                    </h3>
                    <p class="text-lg text-gray-300">
                        Round: <span id="round-number-display" class="font-bold text-white">-</span>
                    </p>
                </div>
                <div class="flex items-center justify-center gap-4">
                    <button onclick="previousTurn()" class="p-2 px-4 bg-gray-600 hover:bg-gray-500 rounded-full font-bold text-lg leading-none transition-colors">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <p id="current-turn-display" class="text-2xl font-bold text-white w-2/3 truncate text-center">
                        Combat has not started.
                    </p>
                    <button onclick="nextTurn()" class="p-2 px-4 bg-gray-600 hover:bg-gray-500 rounded-full font-bold text-lg leading-none transition-colors">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="result-box mt-4 p-0">
                <table id="combat-tracker-table">
                    <thead>
                        <tr>
                            <th class="w-1/12 text-center">
                                <i class="fas fa-bolt"></i> Init
                            </th>
                            <th class="w-4/12">
                                <i class="fas fa-user"></i> Combatant
                            </th>
                            <th class="w-4/12">
                                <i class="fas fa-heart"></i> HP / AC
                            </th>
                            <th class="w-3/12 text-center">
                                <i class="fas fa-cog"></i> Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="combatants-tbody">
                        <tr id="empty-tracker-row">
                            <td colspan="4" class="text-center text-gray-400 italic">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                No combatants added yet.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Live Initiative Sharing (GitHub Pages Only) -->
            <div class="result-box mb-4" id="live-sharing-section" style="display: none;">
                <h3 class="text-xl mb-3" style="color: var(--accent-gold);">
                    <i class="fas fa-share-alt mr-2"></i>
                    Live Initiative Sharing
                </h3>
                
                <div class="mb-3">
                    <div id="sharing-status" class="p-2 rounded text-center" style="background-color: var(--bg-tertiary);">
                        <span class="text-gray-400">âšª Not Sharing</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button onclick="startLiveSharing()" id="start-sharing-btn" class="p-3 bg-blue-700 hover:bg-blue-600 rounded-lg text-white font-bold transition-all">
                        <i class="fas fa-broadcast-tower mr-2"></i>
                        Start Sharing
                    </button>
                    <button onclick="stopLiveSharing()" id="stop-sharing-btn" class="p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white font-bold transition-all" disabled>
                        <i class="fas fa-stop mr-2"></i>
                        Stop Sharing
                    </button>
                </div>
                
                <div id="share-link-container" style="display: none;" class="mt-3">
                    <label class="block text-sm mb-1">Share this link with players:</label>
                    <div class="flex gap-2">
                        <input type="text" id="share-link" readonly class="flex-1 p-2 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);">
                        <button onclick="copyShareLink()" class="p-2 px-4 bg-green-700 hover:bg-green-600 rounded text-white font-bold transition-all">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="text-xs text-gray-400 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        Players will see initiative order and current turn in real-time
                    </div>
                </div>
            </div>

            <!-- Reward Trackers Grid (Side-by-Side on Desktop) -->
            <div class="reward-trackers-grid">
                <!-- XP Calculator -->
                <div class="result-box mb-4">
                    <h3 class="text-xl mb-3" style="color: var(--accent-gold);">
                        <i class="fas fa-calculator mr-2"></i>
                        XP Calculator
                    </h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm mb-1">Total Encounter XP:</label>
                            <input type="number" id="xp-total-input" value="0" readonly class="w-full p-2 rounded text-center" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Number of Players:</label>
                            <input type="number" id="xp-players-input" value="4" min="1" max="10" class="w-full p-2 rounded text-center" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);">
                        </div>
                    </div>
                    <div class="p-3 rounded text-center mb-3" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
                        <div class="text-sm text-gray-400">XP per Player:</div>
                        <div id="xp-per-player" class="text-3xl font-bold" style="color: var(--accent-gold);">0</div>
                    </div>
                    <button onclick="addXPToLog()" class="w-full p-3 bg-green-700 hover:bg-green-600 rounded-lg text-white font-bold transition-all">
                        <i class="fas fa-plus-circle mr-2"></i>
                        Add to XP Log
                    </button>
                    <div id="xp-log" class="mt-3 max-h-32 overflow-y-auto"></div>
                </div>

                <!-- Loot Tracker -->
                <div class="result-box mb-4">
                    <h3 class="text-xl mb-3" style="color: var(--accent-gold);">
                        <i class="fas fa-gem mr-2"></i>
                        Loot Tracker
                    </h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm mb-1">Gold Amount (gp):</label>
                            <input type="number" id="loot-gold-input" value="0" min="0" class="w-full p-2 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Item Name:</label>
                            <input type="text" id="loot-item-input" placeholder="e.g., +1 Sword" class="w-full p-2 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm mb-1">Assigned To:</label>
                        <input type="text" id="loot-player-input" placeholder="Player name" class="w-full p-2 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);">
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button onclick="addLootEntry()" class="p-3 bg-yellow-700 hover:bg-yellow-600 rounded-lg text-white font-bold transition-all">
                            <i class="fas fa-plus mr-2"></i>
                            Add Loot
                        </button>
                        <button onclick="exportLootLog()" class="p-3 bg-blue-700 hover:bg-blue-600 rounded-lg text-white font-bold transition-all">
                            <i class="fas fa-download mr-2"></i>
                            Export Log
                        </button>
                    </div>
                    <div id="loot-log" class="space-y-2 max-h-40 overflow-y-auto"></div>
                </div>
            </div>
            <!-- End Reward Trackers Grid -->
        </div>
        <!-- End of Combat Tab -->
        </div>

        <!-- ==================== NOTES TAB ==================== -->
        <div class="tab-content" id="content-notes">
            <div class="container-card" style="border: none; padding: 0;">
                <h2 class="text-3xl text-center mb-6">
                    <i class="fas fa-sticky-note mr-2"></i>
                    Combat Notes
                </h2>
                
                <div class="result-box">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl" style="color: var(--accent-gold);">
                            <i class="fas fa-pen mr-2"></i>
                            Session Notes
                        </h3>
                        <div class="text-xs text-gray-400">
                            <i class="fas fa-save mr-1"></i>
                            <span id="notes-last-saved">Auto-saved</span>
                        </div>
                    </div>
                    
                    <textarea id="combat-notes-tab" placeholder="Take notes during your session...

Track important events:
- Enemy strategies and weaknesses
- NPC names and locations
- Quest objectives and progress
- Treasure found
- Character moments
- Plot hooks to follow up on

Your notes are automatically saved!" 
                        class="w-full p-3 rounded text-sm resize-vertical" 
                        style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); min-height: 400px; font-family: monospace;"
                        oninput="saveCombatNotesTab()"></textarea>
                    
                    <div class="grid grid-cols-3 gap-3 mt-4">
                        <button onclick="clearCombatNotesTab()" class="p-3 bg-red-600 hover:bg-red-500 rounded text-white font-bold transition-all">
                            <i class="fas fa-trash mr-2"></i>
                            Clear All
                        </button>
                        <button onclick="copyCombatNotesTab()" class="p-3 bg-blue-600 hover:bg-blue-500 rounded text-white font-bold transition-all">
                            <i class="fas fa-copy mr-2"></i>
                            Copy Notes
                        </button>
                        <button onclick="exportCombatNotes()" class="p-3 bg-green-600 hover:bg-green-500 rounded text-white font-bold transition-all">
                            <i class="fas fa-download mr-2"></i>
                            Export .txt
                        </button>
                    </div>
                    
                    <div class="mt-4 p-3 rounded" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
                        <div class="text-sm text-gray-300">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Tips:</strong>
                        </div>
                        <ul class="text-xs text-gray-400 mt-2 space-y-1 ml-4">
                            <li>â€¢ Notes are saved automatically as you type</li>
                            <li>â€¢ Your notes persist even after closing the browser</li>
                            <li>â€¢ Use the Export button to save a backup .txt file</li>
                            <li>â€¢ Great for tracking enemy HP, strategies, and plot developments</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Notes Tab -->

        <!-- ==================== DICE TAB ==================== -->
        <div class="tab-content" id="content-dice">
            <div class="container-card" style="border: none; padding: 0;">
                <h2 class="text-3xl text-center mb-6">
                    <i class="fas fa-dice-d20 mr-2"></i>
                    Dice Roller
                </h2>
                
                <div class="result-box">
                    <h3 class="text-xl mb-4" style="color: var(--accent-gold);">
                        <i class="fas fa-dice mr-2"></i>
                        Quick Roll
                    </h3>
                    
                    <!-- Dice Selection Grid -->
                    <div class="grid grid-cols-6 gap-2 mb-4">
                        <button class="dice-button" onclick="addDiceToRollTab('d4')">d4</button>
                        <button class="dice-button" onclick="addDiceToRollTab('d6')">d6</button>
                        <button class="dice-button" onclick="addDiceToRollTab('d8')">d8</button>
                        <button class="dice-button" onclick="addDiceToRollTab('d10')">d10</button>
                        <button class="dice-button" onclick="addDiceToRollTab('d12')">d12</button>
                        <button class="dice-button" onclick="addDiceToRollTab('d20')">d20</button>
                    </div>
                    
                    <!-- Current Dice Pool -->
                    <div class="mb-4 p-3 rounded" style="background-color: var(--bg-primary); border: 2px solid var(--border-color); min-height: 80px;">
                        <div class="text-sm font-semibold text-gray-400 mb-2">Dice Pool:</div>
                        <div id="dice-pool-display-tab" class="flex flex-wrap gap-2">
                            <span class="text-sm text-gray-500 italic">No dice selected</span>
                        </div>
                    </div>
                    
                    <!-- Modifier Input -->
                    <div class="mb-4 flex gap-3 items-center">
                        <label class="text-sm font-semibold text-gray-300">
                            <i class="fas fa-plus-circle mr-1"></i>
                            Modifier:
                        </label>
                        <input type="number" id="dice-modifier-tab" value="0" class="w-24 p-2 text-center rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);">
                    </div>
                    
                    <!-- Roll and Clear Buttons -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button onclick="rollDicePoolTab()" class="p-3 bg-green-700 hover:bg-green-600 rounded text-white font-bold transition-all">
                            <i class="fas fa-dice-d20 mr-2"></i>
                            Roll All Dice
                        </button>
                        <button onclick="clearDicePoolTab()" class="p-3 bg-red-700 hover:bg-red-600 rounded text-white font-bold transition-all">
                            <i class="fas fa-trash mr-2"></i>
                            Clear Pool
                        </button>
                    </div>
                    
                    <!-- Result Display -->
                    <div id="quick-roll-result-tab" class="text-center font-bold text-3xl p-4 rounded mb-4" style="color: var(--accent-gold); background-color: var(--bg-primary); border: 2px solid var(--border-color); min-height: 60px;"></div>
                </div>
                
                <!-- Custom Dice Rolls -->
                <div class="result-box mt-4">
                    <h3 class="text-xl mb-4" style="color: var(--accent-gold);">
                        <i class="fas fa-star mr-2"></i>
                        Saved Custom Rolls
                    </h3>
                    
                    <div class="mb-4 p-3 rounded" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
                        <div class="text-sm text-gray-300 mb-3">
                            <i class="fas fa-info-circle mr-2"></i>
                            Save frequently used dice combinations for quick access
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                            <input type="text" id="custom-roll-name" placeholder="Roll name (e.g., Fireball)" class="p-2 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);">
                            <input type="text" id="custom-roll-formula" placeholder="Formula (e.g., 8d6)" class="p-2 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);">
                            <button onclick="saveCustomRoll()" class="p-2 bg-blue-700 hover:bg-blue-600 rounded text-white font-bold transition-all">
                                <i class="fas fa-save mr-2"></i>
                                Save Roll
                            </button>
                        </div>
                    </div>
                    
                    <div id="custom-rolls-list" class="space-y-2"></div>
                    
                    <div id="no-custom-rolls" class="text-center text-gray-400 italic p-4">
                        <i class="fas fa-dice mr-2"></i>
                        No custom rolls saved yet
                    </div>
                </div>
                
                <!-- Roll History -->
                <div class="result-box mt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl" style="color: var(--accent-gold);">
                            <i class="fas fa-history mr-2"></i>
                            Roll History
                        </h3>
                        <button onclick="clearDiceHistoryTab()" class="text-xs p-2 bg-red-600 hover:bg-red-500 rounded text-white">
                            <i class="fas fa-trash mr-1"></i>
                            Clear
                        </button>
                    </div>
                    <div id="dice-history-tab" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="text-center text-gray-400 italic">
                            <i class="fas fa-dice-d20 mr-2"></i>
                            No rolls yet
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Dice Tab -->
        
        </div>
    <!-- End Tab Container -->

    <!-- Stat Block Modal -->
    <div id="stat-block-modal" class="stat-block-modal">
        <div class="stat-block-content">
            <div class="flex justify-between items-start">
                <h3 id="modal-monster-name" class="mt-0">
                    <i class="fas fa-book-open mr-2"></i>
                    Monster Name
                </h3>
                <button onclick="hideStatBlock()" class="text-3xl hover:text-red-400 font-bold leading-none transition-colors" style="color: #ef4444;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="input-group mb-4 p-3 rounded-lg border border-yellow-500 border-opacity-30" style="background-color: var(--bg-tertiary);">
                <label for="attack-roll-type" class="block mb-2 text-sm font-semibold text-yellow-300">
                    <i class="fas fa-dice-d20 mr-2"></i>
                    Monster Attack Roll Option
                </label>
                <select id="attack-roll-type" class="w-full p-2 rounded-lg">
                    <option value="Normal">Normal Roll</option>
                    <option value="Advantage">Roll with Advantage</option>
                    <option value="Disadvantage">Roll with Disadvantage</option>
                </select>
            </div>
            <div id="modal-stat-block-content"></div>
            <div id="modal-damage-output" class="p-3">
                <span class="text-gray-500">
                    <i class="fas fa-hand-pointer mr-2"></i>
                    Click an attack name to roll!
                </span>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="hideStatBlock()" class="p-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-white font-bold transition-all">
                    <i class="fas fa-times mr-2"></i>
                    Close
                </button>
                <button onclick="window.print()" class="p-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-bold transition-all">
                    <i class="fas fa-print mr-2"></i>
                    Print
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Dice Roller -->
    <div class="floating-dice-roller" id="floating-dice-roller">
        <div id="dice-roller-content">
            <div class="flex justify-between items-center mb-3 panel-header" data-panel="floating-dice-roller">
                <h4 class="font-bold" style="color: var(--accent-gold);">
                    <i class="fas fa-dice mr-2"></i>
                    Quick Roll
                </h4>
                <button onclick="toggleDiceRoller()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
            
            <!-- Dice Selection Grid -->
            <div class="grid grid-cols-3 gap-2 mb-3">
                <button class="dice-button" onclick="addDiceToRoll('d4')">d4</button>
                <button class="dice-button" onclick="addDiceToRoll('d6')">d6</button>
                <button class="dice-button" onclick="addDiceToRoll('d8')">d8</button>
                <button class="dice-button" onclick="addDiceToRoll('d10')">d10</button>
                <button class="dice-button" onclick="addDiceToRoll('d12')">d12</button>
                <button class="dice-button" onclick="addDiceToRoll('d20')">d20</button>
            </div>
            
            <!-- Current Dice Pool -->
            <div id="dice-pool" class="mb-2 min-h-[60px] p-2 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                <div class="text-xs text-gray-400 mb-1">Dice Pool:</div>
                <div id="dice-pool-display" class="flex flex-wrap gap-1">
                    <span class="text-xs text-gray-500 italic">No dice selected</span>
                </div>
            </div>
            
            <!-- Modifier Input -->
            <div class="mb-2 flex gap-2 items-center">
                <label class="text-xs text-gray-400">Modifier:</label>
                <input type="number" id="dice-modifier" value="0" class="w-16 p-1 text-center rounded text-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);">
            </div>
            
            <!-- Roll and Clear Buttons -->
            <div class="grid grid-cols-2 gap-2 mb-3">
                <button onclick="rollDicePool()" class="p-2 bg-green-600 hover:bg-green-500 rounded text-white font-bold transition-all">
                    <i class="fas fa-dice-d20 mr-1"></i>
                    Roll All
                </button>
                <button onclick="clearDicePool()" class="p-2 bg-red-600 hover:bg-red-500 rounded text-white font-bold transition-all">
                    <i class="fas fa-trash mr-1"></i>
                    Clear
                </button>
            </div>
            
            <!-- Result Display -->
            <div id="quick-roll-result" class="text-center font-bold text-2xl mt-2 p-2 rounded" style="color: var(--accent-gold); background-color: var(--bg-primary); min-height: 40px;"></div>
            
            <button onclick="toggleDiceHistory()" class="w-full mt-2 p-1 text-xs bg-gray-600 hover:bg-gray-500 rounded text-white">
                <i class="fas fa-history mr-1"></i>
                History
            </button>
        </div>
        <div id="dice-roller-collapsed" style="display: none;" onclick="toggleDiceRoller()">
            <i class="fas fa-dice-d20 fa-2x" style="color: var(--accent-gold);"></i>
        </div>
    </div>

    <!-- Dice History -->
    <div class="dice-history" id="dice-history">
        <div class="flex justify-between items-center mb-3">
            <h4 class="font-bold" style="color: var(--accent-gold);">
                <i class="fas fa-history mr-2"></i>
                Roll History
            </h4>
            <button onclick="toggleDiceHistory()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="dice-history-content"></div>
    </div>


    <!-- Combat Notes Panel -->
    <div class="ai-assistant-panel" id="ai-assistant-panel">
        <div id="ai-assistant-content">
            <div class="flex justify-between items-center mb-3 panel-header" data-panel="ai-assistant-panel">
                <h4 class="font-bold" style="color: var(--accent-gold);">
                    <i class="fas fa-sticky-note mr-2"></i>
                    Combat Notes
                </h4>
                <button onclick="toggleAIAssistant()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
            
            <div class="space-y-2">
                <textarea id="combat-notes" placeholder="Take notes during combat...
- Track enemy patterns
- Plan strategies
- Record important moments" 
                    class="w-full p-2 rounded text-sm resize-vertical" 
                    style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); min-height: 200px; font-family: monospace;"
                    oninput="saveCombatNotes()"></textarea>
                
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="clearCombatNotes()" class="p-2 bg-red-600 hover:bg-red-500 rounded text-white text-xs font-bold transition-all">
                        <i class="fas fa-trash mr-1"></i>
                        Clear
                    </button>
                    <button onclick="copyCombatNotes()" class="p-2 bg-blue-600 hover:bg-blue-500 rounded text-white text-xs font-bold transition-all">
                        <i class="fas fa-copy mr-1"></i>
                        Copy
                    </button>
                </div>
                
                <div class="text-xs text-gray-400 text-center">
                    <i class="fas fa-save mr-1"></i>
                    Auto-saves locally
                </div>
            </div>
        </div>
        <div id="ai-assistant-collapsed" style="display: none;" onclick="toggleAIAssistant()">
            <i class="fas fa-sticky-note fa-2x" style="color: var(--accent-gold);"></i>
        </div>
    </div>

    <!-- Encounter Generator Panel -->

    <script>
        // ==================== GLOBAL STATE ====================
        let activeEncounter = [];
        let monsterCount = 0;
        let playerSlotCount = 0;
        let ALL_MONSTERS = [];
        let currentXPBudget = 0;
        let currentTurnIndex = -1;
        let currentRound = 1;
        let currentTheme = 'default';
        let diceHistory = [];
        let dicePool = []; // Array to store selected dice
        
        // AI Assistant state
        let aiAssistantActive = false;
        let aiRequestInProgress = false;
        
        // Live Sharing state
        let liveSharingActive = false;
        let currentSessionId = null;
        let firebaseDb = null;
        let isHostedEnvironment = false;

        // ==================== CONSTANTS ====================
        const XP_THRESHOLDS = {
            1: { Low: 50, Moderate: 75, High: 100, easy: 25, medium: 50, hard: 75, deadly: 100 },
            2: { Low: 100, Moderate: 150, High: 200, easy: 50, medium: 100, hard: 150, deadly: 200 },
            3: { Low: 150, Moderate: 225, High: 400, easy: 75, medium: 150, hard: 225, deadly: 400 },
            4: { Low: 250, Moderate: 375, High: 500, easy: 125, medium: 250, hard: 375, deadly: 500 },
            5: { Low: 500, Moderate: 750, High: 1100, easy: 250, medium: 500, hard: 750, deadly: 1100 },
            6: { Low: 600, Moderate: 900, High: 1400, easy: 300, medium: 600, hard: 900, deadly: 1400 },
            7: { Low: 750, Moderate: 1100, High: 1700, easy: 350, medium: 750, hard: 1100, deadly: 1700 },
            8: { Low: 900, Moderate: 1400, High: 2100, easy: 450, medium: 900, hard: 1400, deadly: 2100 },
            9: { Low: 1100, Moderate: 1600, High: 2400, easy: 550, medium: 1100, hard: 1600, deadly: 2400 },
            10: { Low: 1200, Moderate: 1900, High: 2800, easy: 600, medium: 1200, hard: 1900, deadly: 2800 },
            11: { Low: 1600, Moderate: 2400, High: 3600, easy: 800, medium: 1600, hard: 2400, deadly: 3600 },
            12: { Low: 1900, Moderate: 2900, High: 4300, easy: 1000, medium: 2000, hard: 3000, deadly: 4500 },
            13: { Low: 2100, Moderate: 3200, High: 4800, easy: 1100, medium: 2200, hard: 3400, deadly: 5100 },
            14: { Low: 2400, Moderate: 3800, High: 5700, easy: 1250, medium: 2500, hard: 3800, deadly: 5700 },
            15: { Low: 2800, Moderate: 4300, High: 6400, easy: 1400, medium: 2800, hard: 4300, deadly: 6400 },
            16: { Low: 3300, Moderate: 5000, High: 7500, easy: 1600, medium: 3200, hard: 4800, deadly: 7200 },
            17: { Low: 3900, Moderate: 5900, High: 8800, easy: 2000, medium: 3900, hard: 5900, deadly: 8800 },
            18: { Low: 4700, Moderate: 7100, High: 10500, easy: 2100, medium: 4200, hard: 6300, deadly: 9500 },
            19: { Low: 6000, Moderate: 9000, High: 13500, easy: 2400, medium: 4900, hard: 7300, deadly: 10900 },
            20: { Low: 7500, Moderate: 11000, High: 16500, easy: 2800, medium: 5700, hard: 8500, deadly: 12700 }
        };

        // ==================== THEME MANAGEMENT ====================
        // ==================== TAB SWITCHING ====================
        function switchTab(tabName) {
            // Hide all tab contents
            const allContents = document.querySelectorAll('.tab-content');
            allContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all buttons
            const allButtons = document.querySelectorAll('.tab-button');
            allButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(`content-${tabName}`).classList.add('active');
            
            // Activate selected button
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Save current tab
            localStorage.setItem('dnd-current-tab', tabName);
            
            // Update saved encounters list if switching to archive
            if (tabName === 'archive') {
                loadSavedEncountersList();
            }
        }
        
        function loadSavedEncountersList() {
            const container = document.getElementById('saved-encounters-list');
            const savedEncounters = JSON.parse(localStorage.getItem('saved-encounters') || '[]');
            
            if (savedEncounters.length === 0) {
                container.innerHTML = `
                    <p class="text-center text-gray-400 italic py-8">
                        <i class="fas fa-inbox mr-2"></i>
                        No saved encounters yet. Save an encounter from the Combat tab!
                    </p>
                `;
                return;
            }
            
            let html = '';
            savedEncounters.forEach((encounter, index) => {
                const monsterCount = encounter.combatants.filter(c => c.type === 'monster').length;
                const playerCount = encounter.combatants.filter(c => c.type === 'player').length;
                
                html += `
                    <div class="p-4 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="text-xl font-bold" style="color: var(--accent-gold);">
                                    ${encounter.name}
                                </h3>
                                <p class="text-sm text-gray-400">
                                    <i class="fas fa-users mr-1"></i>
                                    ${playerCount} Players, ${monsterCount} Monsters
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="loadSavedEncounter(${index})" class="px-3 py-1 bg-green-600 hover:bg-green-500 rounded text-white text-sm font-bold transition-all">
                                    <i class="fas fa-upload mr-1"></i>
                                    Load
                                </button>
                                <button onclick="deleteSavedEncounter(${index})" class="px-3 py-1 bg-red-600 hover:bg-red-500 rounded text-white text-sm font-bold transition-all">
                                    <i class="fas fa-trash mr-1"></i>
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div class="text-sm text-gray-300">
                            <strong>Combatants:</strong> ${encounter.combatants.map(c => c.name).join(', ')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function loadSavedEncounter(index) {
            const savedEncounters = JSON.parse(localStorage.getItem('saved-encounters') || '[]');
            const encounter = savedEncounters[index];
            
            if (!encounter) {
                showNotification('âš ï¸ Encounter not found!', 'error');
                return;
            }
            
            // Load the encounter
            activeEncounter = encounter.combatants;
            currentRound = encounter.round || 1;
            currentTurnIndex = encounter.currentTurnIndex || -1;
            
            renderCombatTracker();
            showNotification(`âœ“ Loaded "${encounter.name}"`, 'success');
            
            // Switch to combat tab
            switchTab('combat');
        }
        
        function deleteSavedEncounter(index) {
            if (!confirm('Delete this saved encounter?')) return;
            
            const savedEncounters = JSON.parse(localStorage.getItem('saved-encounters') || '[]');
            savedEncounters.splice(index, 1);
            localStorage.setItem('saved-encounters', JSON.stringify(savedEncounters));
            
            loadSavedEncountersList();
            showNotification('âœ“ Encounter deleted', 'success');
        }
        
        // ==================== THEMES ====================
        function setTheme(theme) {
            currentTheme = theme;
            document.body.setAttribute('data-theme', theme);
            
            document.querySelectorAll('.theme-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (theme === 'default') {
                document.body.removeAttribute('data-theme');
                document.querySelector('.theme-default').classList.add('active');
            } else {
                document.querySelector(`.theme-${theme}`).classList.add('active');
            }
            
            localStorage.setItem('dnd-tracker-theme', theme);
        }

        // ==================== FILE UPLOAD ====================
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    if (!Array.isArray(jsonData)) {
                        throw new Error("JSON data is not an array.");
                    }
                    ALL_MONSTERS = jsonData;
                    showNotification(`âœ“ ${ALL_MONSTERS.length} monsters loaded successfully!`, 'success');
                    populateCreatureTypeDropdown();
                    populateCRDropdown();
                    renderMonsterSuggestions();
                } catch (error) {
                    console.error("Error parsing JSON file:", error);
                    showNotification("âŒ Failed to load monsters. Please check the JSON file format.", 'error');
                    ALL_MONSTERS = [];
                }
            };
            reader.onerror = () => showNotification("âŒ An error occurred while reading the file.", 'error');
            reader.readAsText(file);
        }

        // ==================== SAVE/LOAD ENCOUNTER ====================
        function saveEncounter() {
            if (activeEncounter.length === 0) {
                showNotification("âš ï¸ There is nothing in the combat tracker to save!", 'error');
                return;
            }
            
            const nameInput = document.getElementById('encounter-name-input');
            let encounterName = nameInput.value.trim();
            
            const encounterState = {
                metadata: {
                    name: encounterName,
                    monsterCount: monsterCount,
                    budget: currentXPBudget,
                    savedAt: new Date().toISOString(),
                    theme: currentTheme
                },
                encounterData: activeEncounter
            };
            
            const dataStr = JSON.stringify(encounterState, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            
            let filename;
            if (encounterName) {
                filename = encounterName.replace(/[\\/:*?"<>|]/g, '_') + '.json';
            } else {
                filename = `dnd-encounter-${new Date().getTime()}.json`;
            }
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('âœ“ Encounter saved!', 'success');
        }

        function handleEncounterLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const savedState = JSON.parse(e.target.result);
                    if (!savedState.metadata || !Array.isArray(savedState.encounterData)) {
                        throw new Error("Invalid encounter file format.");
                    }
                    
                    monsterCount = savedState.metadata.monsterCount || 0;
                    currentXPBudget = savedState.metadata.budget || 0;
                    activeEncounter = savedState.encounterData;
                    currentTurnIndex = 0;
                    currentRound = 1;
                    
                    const nameInput = document.getElementById('encounter-name-input');
                    if (savedState.metadata.name) {
                        nameInput.value = savedState.metadata.name;
                    }
                    
                    if (savedState.metadata.theme) {
                        setTheme(savedState.metadata.theme);
                    }
                    
                    showNotification('âœ“ Encounter loaded successfully!', 'success');
                    renderCombatTracker();
                } catch (error) {
                    console.error("Error loading encounter file:", error);
                    showNotification("âŒ Failed to load encounter. Please check the file format.", 'error');
                }
            };
            reader.onerror = () => showNotification("âŒ An error occurred while reading the encounter file.", 'error');
            reader.readAsText(file);
        }

        // ==================== DROPDOWN POPULATION ====================
        function populateCreatureTypeDropdown() {
            const dropdown = document.getElementById('creature-type');
            dropdown.innerHTML = '';
            
            const types = [...new Set(ALL_MONSTERS.map(m => m.type))].sort();
            
            const anyOption = document.createElement('option');
            anyOption.value = "Any Type";
            anyOption.textContent = "Any Type";
            anyOption.selected = true;
            dropdown.appendChild(anyOption);
            
            types.forEach(type => {
                if (type) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    dropdown.appendChild(option);
                }
            });
        }

        function populateCRDropdown() {
            const dropdown = document.getElementById('cr-filter');
            dropdown.innerHTML = '';
            
            const crToNumber = (cr) => {
                if (String(cr).includes('/')) {
                    const [num, den] = cr.split('/');
                    return Number(num) / Number(den);
                }
                return Number(cr);
            };
            
            const crs = [...new Set(ALL_MONSTERS.map(m => m.cr))].sort((a, b) => crToNumber(a) - crToNumber(b));
            
            const anyOption = document.createElement('option');
            anyOption.value = "Any CR";
            anyOption.textContent = "Any CR";
            anyOption.selected = true;
            dropdown.appendChild(anyOption);
            
            crs.forEach(cr => {
                if (cr !== undefined && cr !== null) {
                    const option = document.createElement('option');
                    option.value = cr;
                    option.textContent = `CR ${cr}`;
                    dropdown.appendChild(option);
                }
            });
        }

        // ==================== ENCOUNTER CALCULATION ====================
        function calculateEncounter() {
            if (ALL_MONSTERS.length === 0) {
                showNotification("âš ï¸ Please upload a monster JSON file first.", 'error');
                return;
            }
            
            const level = parseInt(document.getElementById('level').value);
            const players = parseInt(document.getElementById('players').value);
            const difficulty = document.getElementById('difficulty').value;
            const resultsContainer = document.getElementById('results-container');
            
            const typeFilter = document.getElementById('creature-type');
            const selectedTypes = Array.from(typeFilter.selectedOptions).map(opt => opt.value);
            
            const crFilter = document.getElementById('cr-filter');
            const selectedCRs = Array.from(crFilter.selectedOptions).map(opt => opt.value);
            
            if (isNaN(level) || isNaN(players) || level < 1 || level > 20 || players < 1) {
                showNotification("âš ï¸ Please enter valid numbers for Level (1-20) and Players (at least 1).", 'error');
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const xpPerCharacter = XP_THRESHOLDS[level][difficulty] || 0;
            const totalXPBudget = xpPerCharacter * players;
            currentXPBudget = totalXPBudget;
            
            document.getElementById('output-level').textContent = level;
            document.getElementById('output-players').textContent = players;
            document.getElementById('output-difficulty').textContent = difficulty;
            document.getElementById('output-xp-per').textContent = xpPerCharacter;
            document.getElementById('output-budget').textContent = totalXPBudget.toLocaleString();
            document.getElementById('output-budget-2').textContent = totalXPBudget.toLocaleString();
            document.getElementById('output-filters').textContent = `Types: ${selectedTypes.join(', ')} | CRs: ${selectedCRs.join(', ')}`;
            document.getElementById('output-difficulty').className = `font-bold difficulty-${difficulty.toLowerCase()}`;
            document.getElementById('budget-xp-total').textContent = currentXPBudget.toLocaleString();
            document.getElementById('current-xp-total').textContent = '0';
            
            renderMonsterSuggestions(selectedTypes, selectedCRs);
            
            const dynamicInputsContainer = document.getElementById('dynamic-player-inputs');
            dynamicInputsContainer.innerHTML = '';
            playerSlotCount = 0;
            
            for(let i=0; i<players; i++) {
                addPlayerSlot(true);
            }
            
            resultsContainer.classList.remove('hidden');
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
            updateXPProgress();
        }

        // ==================== PLAYER SLOTS ====================
        function addPlayerSlot(autoPopulate = false) {
            playerSlotCount++;
            const container = document.getElementById('dynamic-player-inputs');
            const slotId = playerSlotCount;
            
            const div = document.createElement('div');
            div.id = `player-slot-${slotId}`;
            div.className = 'grid grid-cols-6 gap-2 p-3 rounded-lg border border-yellow-500 border-opacity-30 items-center';
            div.style.backgroundColor = 'var(--bg-tertiary)';
            
            // Load saved data from localStorage
            const savedData = JSON.parse(localStorage.getItem(`player-slot-${slotId}`) || '{}');
            const defaultName = savedData.name || (autoPopulate ? `Player ${slotId}` : '');
            const defaultAC = savedData.ac || (autoPopulate ? 15 : '');
            const defaultHP = savedData.maxHp || (autoPopulate ? 30 : '');
            
            div.innerHTML = `
                <div class="col-span-6 sm:col-span-2">
                    <label class="text-xs text-gray-400 block mb-1">
                        <i class="fas fa-user mr-1"></i>
                        Name
                    </label>
                    <input type="text" id="player-name-${slotId}" placeholder="Player Name" value="${defaultName}" class="w-full p-1 rounded-md text-sm" onchange="savePlayerSlotData(${slotId})">
                </div>
                <div class="col-span-2 sm:col-span-1">
                    <label class="text-xs text-gray-400 block mb-1">
                        <i class="fas fa-shield-alt mr-1"></i>
                        AC
                    </label>
                    <input type="number" id="player-ac-${slotId}" placeholder="AC" value="${defaultAC}" class="w-full p-1 rounded-md text-sm text-center" onchange="savePlayerSlotData(${slotId})">
                </div>
                <div class="col-span-2 sm:col-span-1">
                    <label class="text-xs text-gray-400 block mb-1">
                        <i class="fas fa-heart mr-1"></i>
                        Max HP
                    </label>
                    <input type="number" id="player-maxhp-${slotId}" placeholder="HP" value="${defaultHP}" class="w-full p-1 rounded-md text-sm text-center" onchange="savePlayerSlotData(${slotId})">
                </div>
                <div class="col-span-2 sm:col-span-1">
                    <label class="text-xs text-gray-400 block mb-1">
                        <i class="fas fa-dice-d20 mr-1"></i>
                        Initiative
                    </label>
                    <input type="number" id="player-initiative-${slotId}" placeholder="Roll" value="" class="w-full p-1 rounded-md text-sm text-center" title="Enter player's initiative roll">
                </div>
                <div class="col-span-6 sm:col-span-1 flex flex-row sm:flex-col gap-2 items-center justify-end">
                    <button onclick="addSinglePlayerToEncounter(${slotId})" class="text-green-500 hover:text-green-400 text-xs p-1 whitespace-nowrap">
                        <i class="fas fa-plus mr-1"></i>
                        Add
                    </button>
                    <button onclick="removePlayerSlot(${slotId})" class="text-red-500 hover:text-red-400 text-xs p-1 whitespace-nowrap">
                        <i class="fas fa-trash mr-1"></i>
                        Remove
                    </button>
                </div>
            `;
            
            container.appendChild(div);
        }

        // Save player slot data to localStorage
        function savePlayerSlotData(slotId) {
            const name = document.getElementById(`player-name-${slotId}`)?.value || '';
            const ac = document.getElementById(`player-ac-${slotId}`)?.value || '';
            const maxHp = document.getElementById(`player-maxhp-${slotId}`)?.value || '';
            
            const data = { name, ac, maxHp };
            localStorage.setItem(`player-slot-${slotId}`, JSON.stringify(data));
        }

        // Remove player slot and clear saved data
        function removePlayerSlot(slotId) {
            document.getElementById(`player-slot-${slotId}`)?.remove();
            localStorage.removeItem(`player-slot-${slotId}`);
        }

        // Add a single player to encounter
        function addSinglePlayerToEncounter(slotId) {
            const nameInput = document.getElementById(`player-name-${slotId}`);
            if (!nameInput) {
                showNotification('âŒ Player slot not found!', 'error');
                return;
            }
            
            const name = nameInput.value || `Unnamed Player ${slotId}`;
            const ac = parseInt(document.getElementById(`player-ac-${slotId}`).value) || 10;
            const maxHp = parseInt(document.getElementById(`player-maxhp-${slotId}`).value) || 10;
            const initiativeInput = document.getElementById(`player-initiative-${slotId}`);
            const initiative = initiativeInput && initiativeInput.value ? parseInt(initiativeInput.value) : 10;
            
            if (name.trim() === '' || isNaN(maxHp) || maxHp <= 0) {
                showNotification('âš ï¸ Please enter valid Name and HP!', 'error');
                return;
            }
            
            // Check if player already exists in combat
            const existingPlayer = activeEncounter.find(c => c.id === `p-${slotId}`);
            if (existingPlayer) {
                showNotification(`âš ï¸ ${name} is already in combat!`, 'error');
                return;
            }
            
            activeEncounter.push({
                id: `p-${slotId}`,
                type: 'player',
                name,
                ac,
                maxHp,
                currentHp: maxHp,
                tempHp: 0,
                initBonus: 0,
                initiative: initiative,
                statBlock: null,
                notes: '',
                deathSaves: { successes: 0, failures: 0 }
            });
            
            renderCombatTracker();
            showNotification(`âœ“ ${name} added to combat!`, 'success');
            
            // Update live sharing if active
            if (liveSharingActive) {
                updateSharedInitiative();
            }
        }

        // ==================== MONSTER SUGGESTIONS ====================
        // ==================== MONSTER SEARCH ====================
        function performMonsterSearch() {
            const searchTerm = document.getElementById('monster-search').value.toLowerCase().trim();
            const searchCountDiv = document.getElementById('search-results-count');
            const resultsContainer = document.getElementById('results-container');
            
            if (ALL_MONSTERS.length === 0) {
                searchCountDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-1" style="color: #ef4444;"></i>Upload a monster JSON file first';
                showNotification('âš ï¸ Please upload monsters first!', 'error');
                return;
            }
            
            // If search is empty
            if (searchTerm === '') {
                searchCountDiv.innerHTML = '<i class="fas fa-info-circle mr-1"></i>Type a monster name and press Enter to search';
                showNotification('âš ï¸ Please enter a search term', 'error');
                return;
            }
            
            // Filter monsters by name (case-insensitive, partial match)
            const filteredMonsters = ALL_MONSTERS.filter(monster => 
                monster.name.toLowerCase().includes(searchTerm)
            );
            
            // Update count display
            if (filteredMonsters.length > 0) {
                searchCountDiv.innerHTML = `<i class="fas fa-check-circle mr-1" style="color: #10b981;"></i>Found ${filteredMonsters.length} monster${filteredMonsters.length !== 1 ? 's' : ''} matching "${searchTerm}" - see results below!`;
            } else {
                searchCountDiv.innerHTML = `<i class="fas fa-times-circle mr-1" style="color: #ef4444;"></i>No monsters found matching "${searchTerm}"`;
                showNotification(`âŒ No monsters found matching "${searchTerm}"`, 'error');
                return;
            }
            
            // Show results container
            resultsContainer.classList.remove('hidden');
            
            // Render search results in the suggestions area
            renderSearchResults(filteredMonsters, searchTerm);
            
            // Scroll to results
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Play sound
            playSound('dice-roll');
        }
        
        function renderSearchResults(monsters, searchTerm) {
            const suggestionsList = document.getElementById('monster-suggestions');
            const outputFilters = document.getElementById('output-filters');
            
            // Update header to show it's search results
            outputFilters.textContent = `Search Results for "${searchTerm}"`;
            
            suggestionsList.innerHTML = '';
            
            // Sort by XP
            monsters.sort((a, b) => a.xp - b.xp);
            
            monsters.forEach(monster => {
                const li = document.createElement('li');
                const uniqueId = monster.name.replace(/'/g, "\\'");
                const safeId = monster.name.replace(/[^a-zA-Z0-9]/g, '-');
                
                li.innerHTML = `
                    <div class="monster-info">
                        <div class="font-bold text-lg cursor-pointer hover:underline" style="color: var(--accent-gold-light);" onclick="showStatBlock(ALL_MONSTERS.find(m => m.name === '${uniqueId}'))">
                            <i class="fas fa-book-dead mr-2"></i>
                            ${monster.name}
                        </div>
                        <div class="text-sm space-x-2 mt-1">
                            <span class="font-mono px-2 py-0.5 rounded mr-2" style="background-color: var(--bg-tertiary);">
                                <i class="fas fa-skull-crossbones mr-1"></i>
                                CR ${monster.cr}
                            </span>
                            <span class="font-mono px-2 py-0.5 rounded text-xs" style="background: var(--accent-gold); color: var(--bg-primary);">
                                <i class="fas fa-star mr-1"></i>
                                ${(monster.xp || 0).toLocaleString()} XP
                            </span>
                        </div>
                        <p class="text-xs italic mt-2 text-gray-400">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>Type:</strong> ${monster.type} | <strong>Combat:</strong> ${monster.statSummary || monster.notes || 'No summary'}
                        </p>
                        <p class="text-xs mt-1 text-gray-500">
                            <i class="fas fa-shield-alt mr-1"></i>AC: ${monster.ac} 
                            <i class="fas fa-heart ml-2 mr-1"></i>HP: ${monster.hp} 
                            <i class="fas fa-bolt ml-2 mr-1"></i>Init: +${monster.initBonus}
                        </p>
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="qty-${safeId}" class="p-1 rounded text-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); width: 60px; height: 32px;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                        <button onclick="addMonsterToEncounter('${uniqueId}')" class="p-2 bg-green-600 hover:bg-green-500 rounded-full text-white text-xs font-bold transition-all">
                            <i class="fas fa-plus mr-1"></i>
                            Add
                        </button>
                    </div>
                `;
                
                suggestionsList.appendChild(li);
            });
        }
        
        // Legacy function - kept for compatibility
        function filterMonstersBySearch() {
            // This can be removed or kept for backwards compatibility
        }
        
        function renderFilteredMonsters(monsters) {
            // This can be removed or kept for backwards compatibility
        }
        
        // ==================== MONSTER RENDERING ====================
        function renderMonsterSuggestions(selectedTypes, selectedCRs) {
            const suggestionsList = document.getElementById('monster-suggestions');
            suggestionsList.innerHTML = '';
            
            if (ALL_MONSTERS.length === 0) {
                suggestionsList.innerHTML = '<li class="text-center text-gray-400 italic"><i class="fas fa-info-circle mr-2"></i>Upload a monster JSON file to see suggestions.</li>';
                return;
            }
            
            let monsters = [...ALL_MONSTERS];
            
            if (selectedTypes && !selectedTypes.includes("Any Type") && selectedTypes.length > 0) {
                monsters = monsters.filter(m => selectedTypes.includes(m.type));
            }
            
            if (selectedCRs && !selectedCRs.includes("Any CR") && selectedCRs.length > 0) {
                monsters = monsters.filter(m => selectedCRs.includes(String(m.cr)));
            }
            
            monsters.sort((a, b) => a.xp - b.xp);
            
            if (monsters.length > 0) {
                monsters.forEach(monster => {
                    const li = document.createElement('li');
                    
                    // Create a valid HTML ID by removing special characters
                    const uniqueId = monster.name.replace(/'/g, "\\'");
                    const safeId = monster.name.replace(/[^a-zA-Z0-9]/g, '-');
                    
                    li.innerHTML = `
                        <div class="monster-info">
                            <div class="font-bold text-lg cursor-pointer hover:underline" style="color: var(--accent-gold-light);" onclick="showStatBlock(ALL_MONSTERS.find(m => m.name === '${uniqueId}'))">
                                <i class="fas fa-book-dead mr-2"></i>
                                ${monster.name}
                            </div>
                            <div class="text-sm space-x-2 mt-1">
                                <span class="font-mono px-2 py-0.5 rounded mr-2" style="background-color: var(--bg-tertiary);">
                                    <i class="fas fa-skull-crossbones mr-1"></i>
                                    CR ${monster.cr}
                                </span>
                                <span class="font-mono px-2 py-0.5 rounded text-xs" style="background: var(--accent-gold); color: var(--bg-primary);">
                                    <i class="fas fa-star mr-1"></i>
                                    ${(monster.xp || 0).toLocaleString()} XP
                                </span>
                            </div>
                            <p class="text-xs italic mt-2 text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                <strong>Type:</strong> ${monster.type} | <strong>Combat:</strong> ${monster.statSummary || monster.notes || 'No summary'}
                            </p>
                            <p class="text-xs mt-1 text-gray-500">
                                <i class="fas fa-shield-alt mr-1"></i>AC: ${monster.ac} 
                                <i class="fas fa-heart ml-2 mr-1"></i>HP: ${monster.hp} 
                                <i class="fas fa-bolt ml-2 mr-1"></i>Init: +${monster.initBonus}
                            </p>
                        </div>
                        <div class="flex items-center gap-2">
                            <select id="qty-${safeId}" class="p-1 rounded text-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); width: 60px; height: 32px;">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                            <button onclick="addMonsterToEncounter('${uniqueId}')" class="p-2 bg-green-600 hover:bg-green-500 rounded-full text-white text-xs font-bold transition-all">
                                <i class="fas fa-plus mr-1"></i>
                                Add
                            </button>
                        </div>
                    `;
                    
                    suggestionsList.appendChild(li);
                });
            } else {
                suggestionsList.innerHTML = '<li class="text-center text-gray-400 italic"><i class="fas fa-exclamation-circle mr-2"></i>No monsters found for the selected filters.</li>';
            }
        }

        // ==================== ADD MONSTERS/PLAYERS TO ENCOUNTER ====================
        function addMonsterToEncounter(monsterName) {
            const monsterData = ALL_MONSTERS.find(m => m.name === monsterName);
            if (!monsterData) {
                showNotification("âŒ Monster data not found!", 'error');
                return;
            }
            
            // Get quantity from dropdown (use safe ID)
            const safeId = monsterName.replace(/[^a-zA-Z0-9]/g, '-');
            const qtySelector = document.getElementById(`qty-${safeId}`);
            const quantity = qtySelector ? parseInt(qtySelector.value) : 1;
            
            const currentEncounterXP = activeEncounter.filter(c => c.type === 'monster').reduce((total, monster) => total + (monster.xp || 0), 0);
            const totalXPToAdd = monsterData.xp * quantity;
            
            if ((currentEncounterXP + totalXPToAdd) > currentXPBudget && currentXPBudget > 0) {
                const overBudget = confirm(`âš ï¸ Adding ${quantity} ${monsterName}(s) would exceed the budget!\n\nCurrent XP: ${currentEncounterXP.toLocaleString()}\nBudget: ${currentXPBudget.toLocaleString()}\nXP to add: ${totalXPToAdd.toLocaleString()}\n\nAdd anyway?`);
                if (!overBudget) return;
            }
            
            // Add multiple monsters based on quantity
            for (let i = 0; i < quantity; i++) {
                monsterCount++;
                const newMonster = {
                    id: `m-${monsterCount}`,
                    type: 'monster',
                    name: `${monsterName} #${monsterCount}`,
                    ac: monsterData.ac,
                    maxHp: monsterData.hp,
                    currentHp: monsterData.hp,
                    tempHp: 0,
                    initBonus: monsterData.initBonus,
                    initiative: rollD20(monsterData.initBonus),
                    xp: monsterData.xp || 0,
                    statBlock: monsterData.statBlock || "No stat block available.",
                    notes: '',
                    deathSaves: { successes: 0, failures: 0 }
                };
                
                activeEncounter.push(newMonster);
            }
            
            renderCombatTracker();
            
            if (quantity === 1) {
                showNotification(`âœ“ ${monsterName} added to combat!`, 'success');
            } else {
                showNotification(`âœ“ ${quantity} ${monsterName}s added to combat!`, 'success');
            }
            
            // Update live sharing if active
            if (liveSharingActive) {
                updateSharedInitiative();
            }
        }

        function addPlayersToEncounter() {
            activeEncounter = activeEncounter.filter(c => c.type === 'monster');
            
            for (let i = 1; i <= playerSlotCount; i++) {
                const nameInput = document.getElementById(`player-name-${i}`);
                if (nameInput) {
                    const name = nameInput.value || `Unnamed Player ${i}`;
                    const ac = parseInt(document.getElementById(`player-ac-${i}`).value) || 10;
                    const maxHp = parseInt(document.getElementById(`player-maxhp-${i}`).value) || 10;
                    const initiativeInput = document.getElementById(`player-initiative-${i}`);
                    const initiative = initiativeInput && initiativeInput.value ? parseInt(initiativeInput.value) : 10;
                    
                    if (name.trim() === '' || isNaN(maxHp) || maxHp <= 0) continue;
                    
                    activeEncounter.push({
                        id: `p-${i}`,
                        type: 'player',
                        name,
                        ac,
                        maxHp,
                        currentHp: maxHp,
                        tempHp: 0,
                        initBonus: 0,
                        initiative: initiative,
                        statBlock: null,
                        notes: '',
                        deathSaves: { successes: 0, failures: 0 }
                    });
                }
            }
            
            renderCombatTracker();
            showNotification('âœ“ Players added to combat!', 'success');
            
            // Update live sharing if active
            if (liveSharingActive) {
                updateSharedInitiative();
            }
        }

        // ==================== INITIATIVE & COMBAT CONTROL ====================
        function sortInitiative() {
            activeEncounter.sort((a, b) => b.initiative - a.initiative);
            currentTurnIndex = activeEncounter.length > 0 ? 0 : -1;
            currentRound = 1;
            renderCombatTracker();
            showNotification('âœ“ Initiative sorted!', 'info');
            
            if (turnTimerActive) {
                resetTurnTimer();
            }
            
            // Update live sharing if active
            if (liveSharingActive) {
                updateSharedInitiative();
            }
        }

        function nextTurn() {
            if (activeEncounter.length === 0) return;
            
            if (currentTurnIndex === activeEncounter.length - 1) {
                currentRound++;
            }
            
            currentTurnIndex = (currentTurnIndex + 1) % activeEncounter.length;
            renderCombatTracker();
            
            playSound('turn-change');
            
            // Update live sharing if active
            if (liveSharingActive) {
                updateSharedInitiative();
            }
        }

        function previousTurn() {
            if (activeEncounter.length === 0) return;
            
            if (currentTurnIndex === 0 && currentRound > 1) {
                currentRound--;
            }
            
            currentTurnIndex--;
            if (currentTurnIndex < 0) {
                currentTurnIndex = activeEncounter.length - 1;
            }
            
            renderCombatTracker();
            
            // Update live sharing if active
            if (liveSharingActive) {
                updateSharedInitiative();
            }
        }

        // ==================== DAMAGE/HEALING ====================
        function trackDamage(id, isHeal = false) {
            const combatant = activeEncounter.find(c => c.id === id);
            const amountInput = document.getElementById(`damage-input-${id}`);
            const amount = parseInt(amountInput.value) || 0;
            
            if (!combatant || amount <= 0) return;
            
            if (isHeal) {
                combatant.currentHp = Math.min(combatant.maxHp, combatant.currentHp + amount);
                showDamageNumber(id, amount, 'heal');
                playSound('heal');
            } else {
                if (combatant.tempHp > 0) {
                    const tempDamage = Math.min(amount, combatant.tempHp);
                    combatant.tempHp -= tempDamage;
                    const remainingDamage = amount - tempDamage;
                    if (remainingDamage > 0) {
                        combatant.currentHp = Math.max(0, combatant.currentHp - remainingDamage);
                    }
                } else {
                    combatant.currentHp = Math.max(0, combatant.currentHp - amount);
                }
                showDamageNumber(id, amount, 'damage');
                playSound('hit');
            }
            
            amountInput.value = '';
            renderCombatTracker();
            
            // Update live sharing if active
            if (liveSharingActive) {
                updateSharedInitiative();
            }
        }

        function setTempHP(id) {
            const combatant = activeEncounter.find(c => c.id === id);
            if (!combatant) return;
            
            const amount = prompt(`Set temporary HP for ${combatant.name}:`, combatant.tempHp);
            if (amount !== null) {
                combatant.tempHp = Math.max(0, parseInt(amount) || 0);
                renderCombatTracker();
                
                // Update live sharing if active
                if (liveSharingActive) {
                    updateSharedInitiative();
                }
            }
        }

        function addNote(id) {
            const combatant = activeEncounter.find(c => c.id === id);
            if (!combatant) return;
            
            const note = prompt(`Add note for ${combatant.name}:`, combatant.notes);
            if (note !== null) {
                combatant.notes = note;
                renderCombatTracker();
            }
        }

        // ==================== DEATH SAVES ====================
        function updateDeathSave(id, type, index) {
            const combatant = activeEncounter.find(c => c.id === id);
            if (!combatant || combatant.currentHp > 0) return;
            
            if (type === 'success') {
                combatant.deathSaves.successes = index + 1;
                if (combatant.deathSaves.successes >= 3) {
                    combatant.currentHp = 1;
                    combatant.deathSaves = { successes: 0, failures: 0 };
                    showNotification(`${combatant.name} stabilized!`, 'success');
                }
            } else {
                combatant.deathSaves.failures = index + 1;
                if (combatant.deathSaves.failures >= 3) {
                    if (confirm(`${combatant.name} has died. Remove from combat?`)) {
                        removeCombatant(id);
                        return;
                    }
                }
            }
            
            renderCombatTracker();
        }

        // ==================== COMBAT TRACKER RENDERING ====================
        function renderCombatTracker() {
            const tbody = document.getElementById('combatants-tbody');
            tbody.innerHTML = '';
            
            const turnDisplay = document.getElementById('current-turn-display');
            const roundDisplay = document.getElementById('round-number-display');
            
            const stickyHeader = document.getElementById('sticky-header');
            const stickyTurn = document.getElementById('sticky-current-turn');
            const stickyRound = document.getElementById('sticky-round');
            
            if (currentTurnIndex !== -1 && activeEncounter.length > 0) {
                const currentCombatant = activeEncounter[currentTurnIndex];
                turnDisplay.textContent = currentCombatant.name;
                roundDisplay.textContent = currentRound;
                stickyTurn.textContent = currentCombatant.name;
                stickyRound.textContent = currentRound;
            } else {
                turnDisplay.textContent = 'Combat has not started.';
                roundDisplay.textContent = '-';
            }
            
            const currentEncounterXP = activeEncounter.filter(c => c.type === 'monster').reduce((total, monster) => total + (monster.xp || 0), 0);
            document.getElementById('current-xp-total').textContent = currentEncounterXP.toLocaleString();
            document.getElementById('budget-xp-total').textContent = currentXPBudget.toLocaleString();
            
            updateXPProgress();
            
            if (activeEncounter.length === 0) {
                tbody.innerHTML = '<tr id="empty-tracker-row"><td colspan="4" class="text-center text-gray-400 italic"><i class="fas fa-exclamation-circle mr-2"></i>No combatants added yet.</td></tr>';
                return;
            }
            
            activeEncounter.forEach((c, index) => {
                const isCurrentTurn = index === currentTurnIndex;
                const hpPercent = (c.currentHp / c.maxHp) * 100;
                const tempHpPercent = (c.tempHp / c.maxHp) * 100;
                
                let hpColor = c.currentHp === 0 ? 'bg-gray-500' : 
                              (hpPercent <= 25 ? 'bg-red-600' : 
                              (hpPercent <= 50 ? 'bg-yellow-500' : 'bg-green-600'));
                
                const isBloodied = c.currentHp > 0 && c.currentHp <= c.maxHp / 2;
                const isMonster = c.type === 'monster';
                const nameClass = isMonster ? 'cursor-pointer hover:underline' : '';
                const nameColor = isMonster ? 'var(--accent-gold-light)' : '#a78bfa';
                
                const safeMonsterName = c.name.split(' #')[0].replace(/'/g, "\\'");
                const onClickAction = isMonster ? `onclick="showStatBlock(ALL_MONSTERS.find(m => m.name === '${safeMonsterName}'))"` : '';
                
                const row = document.createElement('tr');
                if (isCurrentTurn) {
                    row.className = 'current-turn-highlight';
                }
                
                let notesHTML = '';
                if (c.notes && c.notes.trim() !== '') {
                    notesHTML = `<div class="combatant-notes"><i class="fas fa-sticky-note mr-1"></i>${c.notes}</div>`;
                }
                
                let deathSavesHTML = '';
                if (c.currentHp === 0 && c.type === 'player') {
                    deathSavesHTML = `
                        <div class="death-saves mt-2">
                            <span class="text-xs mr-2">Death Saves:</span>
                            <div class="flex gap-1">
                                ${[0,1,2].map(i => `
                                    <div class="death-save-dot ${i < c.deathSaves.successes ? 'success' : ''}" 
                                         onclick="updateDeathSave('${c.id}', 'success', ${i})"
                                         title="Success ${i+1}"></div>
                                `).join('')}
                                <span class="mx-2 text-gray-500">|</span>
                                ${[0,1,2].map(i => `
                                    <div class="death-save-dot ${i < c.deathSaves.failures ? 'failure' : ''}" 
                                         onclick="updateDeathSave('${c.id}', 'failure', ${i})"
                                         title="Failure ${i+1}"></div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                row.innerHTML = `
                    <td class="text-center font-bold text-lg">${c.initiative || '?'}</td>
                    <td>
                        <div class="flex items-center">
                            <span class="font-bold text-lg ${nameClass}" style="color: ${nameColor};" ${onClickAction}>
                                ${isMonster ? '<i class="fas fa-dragon mr-2"></i>' : '<i class="fas fa-user-shield mr-2"></i>'}
                                ${c.name}
                                ${isBloodied ? '<i class="fas fa-skull bloodied-icon" title="Bloodied!"></i>' : ''}
                            </span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            <i class="fas fa-bolt mr-1"></i>Init Mod: +${c.initBonus} 
                            <i class="fas fa-shield-alt ml-2 mr-1"></i>AC: ${c.ac}
                        </div>
                        ${notesHTML}
                        ${deathSavesHTML}
                    </td>
                    <td>
                        <div class="font-bold text-sm flex items-center justify-between">
                            <span>
                                <i class="fas fa-heart mr-1"></i>
                                ${c.currentHp} / ${c.maxHp} HP
                            </span>
                            ${c.tempHp > 0 ? `<span class="text-blue-400 text-xs"><i class="fas fa-shield mr-1"></i>${c.tempHp} Temp</span>` : ''}
                        </div>
                        <div class="hp-bar-container">
                            ${c.tempHp > 0 ? `<div class="temp-hp-bar" style="width: ${Math.min(tempHpPercent, 100)}%;"></div>` : ''}
                            <div class="hp-bar ${hpColor}" style="width: ${hpPercent}%;"></div>
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="flex flex-col items-center gap-2">
                            <input type="number" id="damage-input-${c.id}" placeholder="Amt" class="damage-input p-2 rounded text-sm" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); width: 80px; text-align: center;">
                            <div class="flex gap-1 flex-wrap justify-center">
                                <button onclick="trackDamage('${c.id}', false)" class="text-xs p-1 px-2 bg-red-600 hover:bg-red-500 rounded text-white transition-all" title="Deal Damage">
                                    <i class="fas fa-heart-broken"></i>
                                </button>
                                <button onclick="trackDamage('${c.id}', true)" class="text-xs p-1 px-2 bg-blue-600 hover:bg-blue-500 rounded text-white transition-all" title="Heal">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <button onclick="setTempHP('${c.id}')" class="text-xs p-1 px-2 bg-cyan-600 hover:bg-cyan-500 rounded text-white transition-all" title="Set Temp HP">
                                    <i class="fas fa-shield"></i>
                                </button>
                                <button onclick="addNote('${c.id}')" class="text-xs p-1 px-2 bg-yellow-600 hover:bg-yellow-500 rounded text-white transition-all" title="Add Note">
                                    <i class="fas fa-sticky-note"></i>
                                </button>
                                <button onclick="removeCombatant('${c.id}')" class="text-xs p-1 px-2 bg-gray-600 hover:bg-gray-500 rounded text-white transition-all" title="Remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Update XP calculator whenever encounter changes
            updateEncounterXP();
        }

        function removeCombatant(id) {
            const combatant = activeEncounter.find(c => c.id === id);
            if (combatant && !confirm(`Remove ${combatant.name} from combat?`)) {
                return;
            }
            
            activeEncounter = activeEncounter.filter(c => c.id !== id);
            
            if (currentTurnIndex >= activeEncounter.length) {
                currentTurnIndex = activeEncounter.length > 0 ? 0 : -1;
            }
            
            renderCombatTracker();
            showNotification(`âœ“ ${combatant.name} removed from combat`, 'info');
            
            // Update live sharing if active
            if (liveSharingActive) {
                updateSharedInitiative();
            }
        }

        function clearEncounter() {
            if (activeEncounter.length > 0 && !confirm('Clear all combatants from the tracker?')) {
                return;
            }
            
            activeEncounter = [];
            monsterCount = 0;
            currentTurnIndex = -1;
            currentRound = 1;
            document.getElementById('encounter-name-input').value = '';
            
            if (turnTimerActive) {
                toggleTurnTimer();
            }
            
            renderCombatTracker();
            showNotification('âœ“ Combat tracker cleared', 'info');
        }

        // ==================== XP PROGRESS BAR ====================
        function updateXPProgress() {
            const currentXP = activeEncounter.filter(c => c.type === 'monster').reduce((total, monster) => total + (monster.xp || 0), 0);
            const percent = currentXPBudget > 0 ? Math.min((currentXP / currentXPBudget) * 100, 100) : 0;
            
            const progressBar = document.getElementById('xp-progress-bar');
            const progressText = document.getElementById('xp-progress-text');
            
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
            }
            
            if (progressText) {
                progressText.textContent = `${Math.round(percent)}%`;
            }
        }

        // ==================== DAMAGE NUMBER ANIMATION ====================
        function showDamageNumber(id, amount, type) {
            const row = document.querySelector(`input[id="damage-input-${id}"]`)?.closest('tr');
            if (!row) return;
            
            const rect = row.getBoundingClientRect();
            const damageNum = document.createElement('div');
            damageNum.className = `damage-number ${type}`;
            damageNum.textContent = type === 'heal' ? `+${amount}` : `-${amount}`;
            damageNum.style.left = `${rect.left + rect.width / 2}px`;
            damageNum.style.top = `${rect.top + rect.height / 2}px`;
            
            document.body.appendChild(damageNum);
            
            setTimeout(() => {
                damageNum.remove();
            }, 1500);
        }

        // ==================== DICE ROLLING ====================
        function rollD20(bonus) {
            return Math.floor(Math.random() * 20) + 1 + (bonus || 0);
        }

        function rollWithOption(type, bonus) {
            const roll1 = Math.floor(Math.random() * 20) + 1;
            
            if (type === 'Normal') {
                return {
                    result: roll1 + (bonus || 0),
                    rollDescription: `(d20 Roll: ${roll1})`
                };
            }
            
            const roll2 = Math.floor(Math.random() * 20) + 1;
            let finalRoll, rollDescription;
            
            if (type === 'Advantage') {
                finalRoll = Math.max(roll1, roll2);
                rollDescription = `(Rolls: ${roll1}, ${roll2}; Highest: ${finalRoll})`;
            } else {
                finalRoll = Math.min(roll1, roll2);
                rollDescription = `(Rolls: ${roll1}, ${roll2}; Lowest: ${finalRoll})`;
            }
            
            return {
                result: finalRoll + (bonus || 0),
                rollDescription
            };
        }

        function parseAndRollDice(diceString) {
            if (!diceString) return { total: 0, description: "N/A" };
            
            const parts = String(diceString).toLowerCase().match(/(\d+d\d+)([\+\-]\d+)?/);
            
            if (!parts) {
                const flatDamage = parseInt(diceString);
                return !isNaN(flatDamage) ? { total: flatDamage, description: `Flat damage` } : { total: 0, description: "Invalid format." };
            }
            
            const [, dicePart, bonusPart = '+0'] = parts;
            const [numDice, dieType] = dicePart.split('d').map(Number);
            const bonus = parseInt(bonusPart.replace(/\s/g, '')) || 0;
            
            let total = 0, rolls = [];
            for (let i = 0; i < numDice; i++) {
                rolls.push(Math.floor(Math.random() * dieType) + 1);
            }
            
            total = rolls.reduce((sum, roll) => sum + roll, 0);
            const finalTotal = total + bonus;
            const description = `Rolls: [${rolls.join(' + ')}] ${bonus ? (bonus > 0 ? '+' : '') + bonus : ''}`;
            
            return { total: finalTotal, description };
        }

        // ==================== QUICK DICE ROLLER ====================
        // New dice pool system
        let dicePoolId = 0;
        
        function addDiceToRoll(die) {
            dicePoolId++;
            dicePool.push({
                id: dicePoolId,
                die: die,
                sides: parseInt(die.substring(1))
            });
            updateDicePoolDisplay();
            playSound('dice-roll');
        }
        
        function updateDicePoolDisplay() {
            const display = document.getElementById('dice-pool-display');
            
            if (dicePool.length === 0) {
                display.innerHTML = '<span class="text-xs text-gray-500 italic">No dice selected</span>';
                return;
            }
            
            display.innerHTML = dicePool.map(d => `
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-bold" style="background-color: var(--accent-gold); color: var(--bg-primary);">
                    ${d.die}
                    <button onclick="removeDiceFromPool(${d.id})" class="hover:text-red-600 transition-colors">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `).join('');
        }
        
        function removeDiceFromPool(id) {
            dicePool = dicePool.filter(d => d.id !== id);
            updateDicePoolDisplay();
        }
        
        function clearDicePool() {
            dicePool = [];
            document.getElementById('dice-modifier').value = 0;
            document.getElementById('quick-roll-result').textContent = '';
            updateDicePoolDisplay();
        }
        
        function rollDicePool() {
            if (dicePool.length === 0) {
                showNotification('âš ï¸ Add some dice to the pool first!', 'error');
                return;
            }
            
            const modifier = parseInt(document.getElementById('dice-modifier').value) || 0;
            let total = 0;
            let rolls = [];
            let rollDetails = [];
            
            // Group dice by type for display
            const diceByType = {};
            dicePool.forEach(d => {
                if (!diceByType[d.die]) {
                    diceByType[d.die] = [];
                }
                const roll = Math.floor(Math.random() * d.sides) + 1;
                diceByType[d.die].push(roll);
                total += roll;
                rolls.push(roll);
            });
            
            // Create display string
            Object.keys(diceByType).sort().forEach(die => {
                const diceRolls = diceByType[die];
                rollDetails.push(`${diceRolls.length}${die}: [${diceRolls.join(', ')}]`);
            });
            
            const finalTotal = total + modifier;
            const modifierText = modifier !== 0 ? ` ${modifier > 0 ? '+' : ''}${modifier}` : '';
            
            const resultDiv = document.getElementById('quick-roll-result');
            resultDiv.innerHTML = `
                <div class="text-3xl font-black">${finalTotal}</div>
                <div class="text-xs text-gray-400 mt-1">${rollDetails.join(' | ')}${modifierText}</div>
                <div class="text-xs text-gray-500 mt-1">Sum: ${total}${modifierText} = ${finalTotal}</div>
            `;
            
            resultDiv.style.animation = 'none';
            setTimeout(() => {
                resultDiv.style.animation = 'pulse 0.5s';
            }, 10);
            
            // Add to history
            const historyText = `${dicePool.length} dice: ${finalTotal} (${rollDetails.join(', ')}${modifierText})`;
            addToDiceHistory(historyText);
            playSound('dice-roll');
        }
        
        function quickRoll(die) {
            const sides = parseInt(die.substring(1));
            const result = Math.floor(Math.random() * sides) + 1;
            
            const resultDiv = document.getElementById('quick-roll-result');
            resultDiv.innerHTML = `
                <div class="text-3xl font-black">${result}</div>
                <div class="text-xs text-gray-400 mt-1">${die}</div>
            `;
            resultDiv.style.animation = 'none';
            setTimeout(() => {
                resultDiv.style.animation = 'pulse 0.5s';
            }, 10);
            
            addToDiceHistory(`${die}: ${result}`);
            playSound('dice-roll');
        }

        function toggleDiceRoller() {
            const roller = document.getElementById('floating-dice-roller');
            const content = document.getElementById('dice-roller-content');
            const collapsed = document.getElementById('dice-roller-collapsed');
            
            if (roller.classList.contains('collapsed')) {
                roller.classList.remove('collapsed');
                content.style.display = 'block';
                collapsed.style.display = 'none';
            } else {
                roller.classList.add('collapsed');
                content.style.display = 'none';
                collapsed.style.display = 'flex';
            }
        }

        function addToDiceHistory(roll) {
            diceHistory.unshift({
                roll: roll,
                timestamp: new Date().toLocaleTimeString()
            });
            
            if (diceHistory.length > 20) {
                diceHistory.pop();
            }
            
            updateDiceHistory();
        }

        function updateDiceHistory() {
            const historyContent = document.getElementById('dice-history-content');
            if (!historyContent) return;
            
            if (diceHistory.length === 0) {
                historyContent.innerHTML = '<div class="text-center text-gray-400 text-sm">No rolls yet</div>';
                return;
            }
            
            historyContent.innerHTML = diceHistory.map(item => `
                <div class="dice-history-item">
                    <div class="font-bold" style="color: var(--accent-gold);">${item.roll}</div>
                    <div class="text-xs text-gray-400">${item.timestamp}</div>
                </div>
            `).join('');
        }

        function toggleDiceHistory() {
            const history = document.getElementById('dice-history');
            history.classList.toggle('visible');
        }

        // ==================== STAT BLOCK MODAL ====================
        window.showStatBlock = function(monsterData) {
            if (!monsterData || !monsterData.statBlock) {
                showNotification("âŒ Stat block not found.", 'error');
                return;
            }
            
            const modal = document.getElementById('stat-block-modal');
            document.getElementById('modal-monster-name').textContent = monsterData.name;
            document.getElementById('modal-damage-output').innerHTML = '<span class="text-gray-500"><i class="fas fa-hand-pointer mr-2"></i>Click an attack name to roll!</span>';
            document.getElementById('modal-stat-block-content').innerHTML = processAttackLines(monsterData.statBlock);
            
            modal.style.display = 'flex';
        };

        window.hideStatBlock = function() {
            document.getElementById('stat-block-modal').style.display = 'none';
        };

        window.performAttackRoll = function(attackBonusStr, diceString, attackName) {
            const attackBonus = parseInt(attackBonusStr) || 0;
            const rollType = document.getElementById('attack-roll-type').value;
            
            const { result: finalToHit, rollDescription } = rollWithOption(rollType, attackBonus);
            const { total: finalDamage, description: damageDesc } = parseAndRollDice(diceString);
            
            const outputDiv = document.getElementById('modal-damage-output');
            const isCrit = rollDescription.includes('20') && finalToHit >= 20 + attackBonus;
            const actualDamage = isCrit ? finalDamage * 2 : finalDamage;
            
            // Generate target selection dropdown
            let targetOptions = '<option value="">-- Select Target --</option>';
            let targetCount = 0;
            
            activeEncounter.forEach(combatant => {
                if (combatant.currentHp > 0) {
                    targetOptions += `<option value="${combatant.id}">${combatant.name} (${combatant.currentHp}/${combatant.maxHp} HP)</option>`;
                    targetCount++;
                }
            });
            
            outputDiv.innerHTML = `
                <div class="text-sm mb-2 font-bold" style="color: var(--accent-gold);">
                    <i class="fas fa-bolt mr-2"></i>
                    ATTACK RESULT: ${attackName} ${isCrit ? '<span class="text-yellow-300">(CRITICAL HIT!)</span>' : ''}
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="result-box-roll border border-orange-400">
                        <div class="text-sm font-semibold text-orange-400">
                            <i class="fas fa-bullseye mr-1"></i>
                            TO HIT (+${attackBonus})
                        </div>
                        <div id="modal-to-hit-result">${finalToHit}</div>
                        <div class="text-xs text-gray-400">${rollDescription}</div>
                    </div>
                    <div class="result-box-roll border border-green-500">
                        <div class="text-sm font-semibold text-green-500">
                            <i class="fas fa-heart-broken mr-1"></i>
                            DAMAGE (${diceString || 'N/A'})
                        </div>
                        <div id="modal-damage-result">${actualDamage}</div>
                        <div class="text-xs text-gray-400">(${damageDesc})${isCrit ? ' x2' : ''}</div>
                    </div>
                </div>
                ${activeEncounter.length > 0 && targetCount > 0 ? `
                    <div class="border-t border-gray-600 pt-4 mt-4">
                        <div class="text-sm font-bold mb-2" style="color: var(--accent-gold);">
                            <i class="fas fa-crosshairs mr-2"></i>
                            Apply Damage to Target:
                        </div>
                        <div class="flex gap-2">
                            <select id="attack-target-select" class="flex-1 p-2 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);">
                                ${targetOptions}
                            </select>
                            <button onclick="applyAttackDamage(${actualDamage})" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded font-bold text-white transition-all">
                                <i class="fas fa-heart-broken mr-1"></i>
                                Apply ${actualDamage} Damage
                            </button>
                        </div>
                    </div>
                ` : `<div class="text-center text-gray-400 text-sm mt-4 p-3 border-t border-gray-600">
                    <i class="fas fa-info-circle mr-2"></i>
                    ${activeEncounter.length === 0 ? 'No combatants in tracker. Add combatants to Combat Tab first!' : 'All combatants are at 0 HP'}
                </div>`}
            `;
            
            outputDiv.scrollIntoView({ behavior: 'smooth' });
            addToDiceHistory(`${attackName}: To Hit ${finalToHit}, Damage ${actualDamage}`);
            playSound(isCrit ? 'crit' : 'hit');
        };

        window.applyAttackDamage = function(damage) {
            const targetSelect = document.getElementById('attack-target-select');
            const targetId = targetSelect.value;
            
            if (!targetId) {
                showNotification('âš ï¸ Please select a target first!', 'error');
                return;
            }
            
            const target = activeEncounter.find(c => c.id === targetId);
            if (!target) {
                showNotification('âŒ Target not found!', 'error');
                return;
            }
            
            // Apply damage
            target.currentHp = Math.max(0, target.currentHp - damage);
            
            // Update combat tracker
            renderCombatTracker();
            
            // Show notification
            showNotification(`ðŸ’¥ ${damage} damage dealt to ${target.name}! (${target.currentHp}/${target.maxHp} HP remaining)`, 'success');
            
            // Play hit sound
            playSound('hit');
            
            // Check if target is down
            if (target.currentHp === 0) {
                showNotification(`ðŸ’€ ${target.name} has been reduced to 0 HP!`, 'error');
                playSound('death');
            }
        };


        function processAttackLines(text) {
            const lines = text.split('\n');
            let processedLines = [];
            
            const attackWithDiceRegex = /^\*\s*\*\*(.*?):\*\*\s*(.*?:\s*([+\-]\d+)\s*to hit)(.*?)(\d+)\s*\(((\d+d\d+)( ?[\+\-]? ?\d+)?)\)(.*?)$/i;
            const attackWithFlatDamageRegex = /^\*\s*\*\*(.*?):\*\*\s*(.*?:\s*([+\-]\d+)\s*to hit),.*?(\d+)\s*(\w+\s*damage.*?)$/i;
            const nonAttackActionRegex = /^\*\s*\*\*(.*?):\*\*\s*(.*?)$/i;
            
            lines.forEach(line => {
                let match;
                
                if ((match = line.match(attackWithDiceRegex))) {
                    const [, attackName, preDamageContent, attackBonus, , , fullDiceNotation, , , remainder] = match.map(s => s ? s.trim() : '');
                    processedLines.push(`
                        <div class="stat-line-container flex flex-wrap items-start rounded-md p-2 my-2 border-l-4" style="background-color: var(--bg-tertiary); border-color: var(--accent-gold);">
                            <span onclick="performAttackRoll('${attackBonus}', '${fullDiceNotation.replace(/\s/g, '')}', '${attackName}')" class="attack-link" style="cursor: pointer;">
                                <i class="fas fa-sword mr-1"></i>
                                ${attackName}
                            </span>
                            <span class="ml-2 text-sm text-gray-300">${preDamageContent}, ${remainder}</span>
                        </div>
                    `);
                } else if ((match = line.match(attackWithFlatDamageRegex))) {
                    const [, attackName, preDamageContent, attackBonus, flatDamage, remainder] = match.map(s => s ? s.trim() : '');
                    processedLines.push(`
                        <div class="stat-line-container flex flex-wrap items-start rounded-md p-2 my-2 border-l-4" style="background-color: var(--bg-tertiary); border-color: var(--accent-gold);">
                            <span onclick="performAttackRoll('${attackBonus}', '${flatDamage}', '${attackName}')" class="attack-link" style="cursor: pointer;">
                                <i class="fas fa-sword mr-1"></i>
                                ${attackName}
                            </span>
                            <span class="ml-2 text-sm text-gray-300">${preDamageContent}, ${flatDamage} ${remainder}</span>
                        </div>
                    `);
                } else if ((match = line.match(nonAttackActionRegex))) {
                    const [, traitName, traitDescription] = match;
                    processedLines.push(`<div class="stat-line-container"><strong>${traitName.trim()}:</strong> ${traitDescription.trim()}</div>`);
                } else if (line.trim()) {
                    processedLines.push(`<div>${line.trim()}</div>`);
                }
            });
            
            return processedLines.join('').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }


        // ==================== NOTIFICATIONS ====================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.backgroundColor = 'var(--bg-secondary)';
            notification.style.border = `2px solid var(--accent-gold)`;
            
            let icon = 'fa-info-circle';
            let color = 'var(--accent-gold)';
            
            if (type === 'success') {
                icon = 'fa-check-circle';
                color = '#22c55e';
            } else if (type === 'error') {
                icon = 'fa-exclamation-circle';
                color = '#ef4444';
            }
            
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas ${icon}" style="color: ${color};"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ==================== SOUND EFFECTS ====================
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                let frequency = 440;
                let duration = 0.1;
                
                switch(type) {
                    case 'hit':
                        frequency = 200;
                        duration = 0.15;
                        break;
                    case 'heal':
                        frequency = 600;
                        duration = 0.2;
                        break;
                    case 'crit':
                        frequency = 800;
                        duration = 0.3;
                        break;
                    case 'dice-roll':
                        frequency = 500;
                        duration = 0.1;
                        break;
                    case 'turn-change':
                        frequency = 400;
                        duration = 0.1;
                        break;
                }
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                // Silently fail if audio is not supported
            }
        }

        // ==================== KEYBOARD SHORTCUTS ====================
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    nextTurn();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextTurn();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    previousTurn();
                    break;
                case 'd':
                case 'D':
                    if (!document.getElementById('floating-dice-roller').classList.contains('collapsed')) {
                        e.preventDefault();
                        quickRoll('d20');
                    }
                    break;
                case 'Escape':
                    hideStatBlock();
                    document.getElementById('status-selector').style.display = 'none';
                    break;
            }
        });

        // ==================== SCROLL HANDLING ====================
        window.addEventListener('scroll', () => {
            const header = document.getElementById('sticky-header');
            if (window.scrollY > 200 && activeEncounter.length > 0 && currentTurnIndex !== -1) {
                header.classList.add('visible');
            } else {
                header.classList.remove('visible');
            }
        });

        // ==================== TOUCH GESTURES ====================
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    nextTurn();
                } else {
                    previousTurn();
                }
            }
        }

        // ==================== MULTI-SELECT SETUP ====================
        function setupMultiSelect(filterId) {
            const filterElement = document.getElementById(filterId);
            filterElement.addEventListener('change', () => {
                const selectedOptions = Array.from(filterElement.selectedOptions).map(opt => opt.value);
                const anyOption = filterElement.options[0];
                
                if (selectedOptions.length > 1 && selectedOptions.includes(anyOption.value)) {
                    Array.from(filterElement.options).forEach(option => {
                        option.selected = (option.value === anyOption.value);
                    });
                } else if (selectedOptions.length > 0 && !selectedOptions.includes(anyOption.value)) {
                    anyOption.selected = false;
                } else if (selectedOptions.length === 0) {
                    anyOption.selected = true;
                }
            });
        }

        // ==================== COMBAT NOTES ====================
        function toggleAIAssistant() {
            const panel = document.getElementById('ai-assistant-panel');
            const content = document.getElementById('ai-assistant-content');
            const collapsed = document.getElementById('ai-assistant-collapsed');
            
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                content.style.display = 'block';
                collapsed.style.display = 'none';
            } else {
                panel.classList.add('collapsed');
                content.style.display = 'none';
                collapsed.style.display = 'flex';
            }
        }
        
        function saveCombatNotes() {
            const notes = document.getElementById('combat-notes').value;
            localStorage.setItem('dnd-combat-notes', notes);
        }
        
        function loadCombatNotes() {
            const notes = localStorage.getItem('dnd-combat-notes') || '';
            document.getElementById('combat-notes').value = notes;
        }
        
        function clearCombatNotes() {
            if (confirm('Clear all combat notes?')) {
                document.getElementById('combat-notes').value = '';
                localStorage.removeItem('dnd-combat-notes');
                showNotification('âœ“ Notes cleared', 'success');
            }
        }
        
        function copyCombatNotes() {
            const notes = document.getElementById('combat-notes');
            notes.select();
            try {
                document.execCommand('copy');
                showNotification('âœ“ Notes copied to clipboard!', 'success');
                playSound('dice-roll');
            } catch (err) {
                showNotification('âš ï¸ Failed to copy', 'error');
            }
        }
        
        // ==================== COMBAT NOTES ====================
        function toggleAIAssistant() {
            const panel = document.getElementById('ai-assistant-panel');
            const content = document.getElementById('ai-assistant-content');
            const collapsed = document.getElementById('ai-assistant-collapsed');
            
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                content.style.display = 'block';
                collapsed.style.display = 'none';
            } else {
                panel.classList.add('collapsed');
                content.style.display = 'none';
                collapsed.style.display = 'flex';
            }
        }
        
        // ==================== DRAGGABLE PANELS ====================
        let activePanel = null;
        let offset = [0, 0];
        let isDown = false;
        
        function initializeDraggablePanels() {
            // Make all panels draggable by their headers AND when collapsed
            const panels = [
                { id: 'floating-dice-roller', header: '.floating-dice-roller .panel-header', collapsed: '#dice-roller-collapsed' },
                { id: 'ai-assistant-panel', header: '.ai-assistant-panel .panel-header', collapsed: '#ai-assistant-collapsed' }
            ];
            
            panels.forEach(({ id, header, collapsed }) => {
                const panelElement = document.getElementById(id);
                const headerElement = document.querySelector(header);
                const collapsedElement = document.querySelector(collapsed);
                
                if (!panelElement || !headerElement) return;
                
                // Drag handler for expanded state (header)
                headerElement.addEventListener('mousedown', function(e) {
                    // Don't drag if clicking buttons or inputs
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || 
                        e.target.tagName === 'SELECT' || e.target.closest('button')) {
                        return;
                    }
                    
                    isDown = true;
                    activePanel = panelElement;
                    offset = [
                        activePanel.offsetLeft - e.clientX,
                        activePanel.offsetTop - e.clientY
                    ];
                    activePanel.style.cursor = 'grabbing';
                }, true);
                
                // Drag handler for collapsed state (entire circle)
                if (collapsedElement) {
                    collapsedElement.addEventListener('mousedown', function(e) {
                        // Check if shift key is held (for dragging instead of expanding)
                        // OR if dragging from edge of circle (not center)
                        const rect = collapsedElement.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        const distanceFromCenter = Math.sqrt(
                            Math.pow(e.clientX - centerX, 2) + 
                            Math.pow(e.clientY - centerY, 2)
                        );
                        
                        // If clicking near edge (outer 40% of radius) or holding Shift, drag instead of expand
                        if (e.shiftKey || distanceFromCenter > (rect.width / 4)) {
                            e.stopPropagation(); // Prevent expansion
                            
                            isDown = true;
                            activePanel = panelElement;
                            offset = [
                                activePanel.offsetLeft - e.clientX,
                                activePanel.offsetTop - e.clientY
                            ];
                            activePanel.style.cursor = 'grabbing';
                        }
                    }, true);
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isDown && activePanel) {
                    // Save position
                    const panelId = activePanel.id;
                    localStorage.setItem(`panel-position-${panelId}`, JSON.stringify({
                        left: activePanel.style.left,
                        top: activePanel.style.top
                    }));
                    activePanel.style.cursor = '';
                }
                isDown = false;
                activePanel = null;
            }, true);
            
            document.addEventListener('mousemove', function(e) {
                e.preventDefault();
                if (isDown && activePanel) {
                    activePanel.style.left = (e.clientX + offset[0]) + 'px';
                    activePanel.style.top = (e.clientY + offset[1]) + 'px';
                    activePanel.style.right = 'auto';
                    activePanel.style.bottom = 'auto';
                }
            }, true);
            
            console.log('Simple drag system initialized (with collapsed dragging)');
        }
        
        function loadPanelPositions() {
            const panels = ['floating-dice-roller', 'ai-assistant-panel'];
            
            panels.forEach(panelId => {
                const panel = document.getElementById(panelId);
                if (!panel) return;
                
                // Load position
                const savedPosition = localStorage.getItem(`panel-position-${panelId}`);
                if (savedPosition) {
                    const position = JSON.parse(savedPosition);
                    if (position.left && position.top) {
                        panel.style.left = position.left;
                        panel.style.top = position.top;
                        panel.style.right = 'auto';
                        panel.style.bottom = 'auto';
                    }
                }
                
                // Load size
                const savedSize = localStorage.getItem(`panel-size-${panelId}`);
                if (savedSize) {
                    const size = JSON.parse(savedSize);
                    if (size.width && size.height) {
                        panel.style.width = size.width;
                        panel.style.height = size.height;
                    }
                }
            });
        }
        
        function resetPanelPositions() {
            // Clear saved positions
            localStorage.removeItem('panel-position-floating-dice-roller');
            localStorage.removeItem('panel-position-ai-assistant-panel');
            localStorage.removeItem('panel-size-floating-dice-roller');
            localStorage.removeItem('panel-size-ai-assistant-panel');
            
            // Reset panels to default positions
            const diceRoller = document.getElementById('floating-dice-roller');
            const aiPanel = document.getElementById('ai-assistant-panel');
            
            if (diceRoller) {
                diceRoller.style.left = 'auto';
                diceRoller.style.top = 'auto';
                diceRoller.style.right = '20px';
                diceRoller.style.bottom = '20px';
                diceRoller.style.width = '';
                diceRoller.style.height = '';
                diceRoller.classList.remove('collapsed');
                document.getElementById('dice-roller-content').style.display = 'block';
                document.getElementById('dice-roller-collapsed').style.display = 'none';
            }
            
            if (aiPanel) {
                aiPanel.style.left = 'auto';
                aiPanel.style.top = 'auto';
                aiPanel.style.right = '320px';
                aiPanel.style.bottom = '20px';
                aiPanel.style.width = '';
                aiPanel.style.height = '';
                aiPanel.classList.remove('collapsed');
                document.getElementById('ai-assistant-content').style.display = 'block';
                document.getElementById('ai-assistant-collapsed').style.display = 'none';
            }
            
            showNotification('âœ“ Panel positions reset!', 'success');
        }
        
        // ==================== INITIALIZATION ====================
        
        // ==================== NEW TAB FUNCTIONS ====================
        
        // Dice Tab Functions
        let dicePoolTab = [];
        let customDiceRolls = JSON.parse(localStorage.getItem('dnd-custom-rolls') || '[]');
        let diceHistoryTab = [];
        
        function addDiceToRollTab(diceType) {
            dicePoolTab.push(diceType);
            renderDicePoolTab();
            playSound('dice');
        }
        
        function renderDicePoolTab() {
            const display = document.getElementById('dice-pool-display-tab');
            if (dicePoolTab.length === 0) {
                display.innerHTML = '<span class="text-sm text-gray-500 italic">No dice selected</span>';
                return;
            }
            
            const diceCounts = {};
            dicePoolTab.forEach(d => diceCounts[d] = (diceCounts[d] || 0) + 1);
            
            display.innerHTML = Object.entries(diceCounts).map(([dice, count]) => `
                <div class="dice-pool-item">
                    <span>${count}${dice}</span>
                    <button onclick="removeDiceFromPoolTab('${dice}')" class="ml-1 text-red-400 hover:text-red-300">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function removeDiceFromPoolTab(diceType) {
            const index = dicePoolTab.indexOf(diceType);
            if (index > -1) {
                dicePoolTab.splice(index, 1);
                renderDicePoolTab();
            }
        }
        
        function clearDicePoolTab() {
            dicePoolTab = [];
            renderDicePoolTab();
            document.getElementById('quick-roll-result-tab').textContent = '';
        }
        
        function rollDicePoolTab() {
            if (dicePoolTab.length === 0) {
                showNotification('âš ï¸ Add dice to the pool first!', 'error');
                return;
            }
            
            const modifier = parseInt(document.getElementById('dice-modifier-tab').value) || 0;
            let total = modifier;
            let rolls = [];
            
            dicePoolTab.forEach(dice => {
                const sides = parseInt(dice.substring(1));
                const roll = Math.floor(Math.random() * sides) + 1;
                total += roll;
                rolls.push(`${dice}:${roll}`);
            });
            
            const result = `${total}`;
            const description = `${rolls.join(', ')}${modifier !== 0 ? ` ${modifier >= 0 ? '+' : ''}${modifier}` : ''}`;
            
            document.getElementById('quick-roll-result-tab').textContent = result;
            
            addToDiceHistoryTab(`${description} = ${total}`);
            playSound('dice');
        }
        
        function addToDiceHistoryTab(roll) {
            diceHistoryTab.unshift({
                roll: roll,
                timestamp: new Date().toLocaleTimeString()
            });
            
            if (diceHistoryTab.length > 50) {
                diceHistoryTab.pop();
            }
            
            updateDiceHistoryTab();
        }
        
        function updateDiceHistoryTab() {
            const historyDiv = document.getElementById('dice-history-tab');
            if (!historyDiv) return;
            
            if (diceHistoryTab.length === 0) {
                historyDiv.innerHTML = '<div class="text-center text-gray-400 italic"><i class="fas fa-dice-d20 mr-2"></i>No rolls yet</div>';
                return;
            }
            
            historyDiv.innerHTML = diceHistoryTab.map(item => `
                <div class="p-2 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                    <div class="font-bold text-sm" style="color: var(--accent-gold);">${item.roll}</div>
                    <div class="text-xs text-gray-400">${item.timestamp}</div>
                </div>
            `).join('');
        }
        
        function clearDiceHistoryTab() {
            if (confirm('Clear all roll history?')) {
                diceHistoryTab = [];
                updateDiceHistoryTab();
            }
        }
        
        // Custom Dice Rolls Functions
        function saveCustomRoll() {
            const name = document.getElementById('custom-roll-name').value.trim();
            const formula = document.getElementById('custom-roll-formula').value.trim();
            
            if (!name || !formula) {
                showNotification('âš ï¸ Please enter both name and formula!', 'error');
                return;
            }
            
            // Validate formula (basic check)
            if (!/^\d+d\d+(\+\d+)?$/.test(formula)) {
                showNotification('âš ï¸ Invalid formula! Use format like "2d6" or "3d8+5"', 'error');
                return;
            }
            
            const customRoll = { id: Date.now(), name, formula };
            customDiceRolls.push(customRoll);
            localStorage.setItem('dnd-custom-rolls', JSON.stringify(customDiceRolls));
            
            document.getElementById('custom-roll-name').value = '';
            document.getElementById('custom-roll-formula').value = '';
            
            renderCustomRolls();
            showNotification(`âœ“ Saved "${name}"!`, 'success');
        }
        
        function renderCustomRolls() {
            const list = document.getElementById('custom-rolls-list');
            const noRolls = document.getElementById('no-custom-rolls');
            
            if (customDiceRolls.length === 0) {
                list.innerHTML = '';
                noRolls.style.display = 'block';
                return;
            }
            
            noRolls.style.display = 'none';
            list.innerHTML = customDiceRolls.map(roll => `
                <div class="p-3 rounded flex justify-between items-center" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                    <div>
                        <div class="font-bold" style="color: var(--accent-gold);">${roll.name}</div>
                        <div class="text-sm text-gray-400">${roll.formula}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="rollCustomDice('${roll.formula}', '${roll.name}')" class="p-2 bg-green-600 hover:bg-green-500 rounded text-white text-sm">
                            <i class="fas fa-dice-d20"></i> Roll
                        </button>
                        <button onclick="deleteCustomRoll(${roll.id})" class="p-2 bg-red-600 hover:bg-red-500 rounded text-white text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function rollCustomDice(formula, name) {
            // Parse formula like "2d6+3"
            const match = formula.match(/^(\d+)d(\d+)(\+\d+)?$/);
            if (!match) return;
            
            const count = parseInt(match[1]);
            const sides = parseInt(match[2]);
            const modifier = match[3] ? parseInt(match[3]) : 0;
            
            let total = modifier;
            let rolls = [];
            
            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                total += roll;
                rolls.push(roll);
            }
            
            const description = `${name}: ${rolls.join('+')}${modifier !== 0 ? ` ${modifier >= 0 ? '+' : ''}${modifier}` : ''}`;
            
            document.getElementById('quick-roll-result-tab').textContent = total;
            addToDiceHistoryTab(`${description} = ${total}`);
            playSound('dice');
            showNotification(`ðŸŽ² ${name}: ${total}`, 'success');
        }
        
        function deleteCustomRoll(id) {
            if (confirm('Delete this custom roll?')) {
                customDiceRolls = customDiceRolls.filter(r => r.id !== id);
                localStorage.setItem('dnd-custom-rolls', JSON.stringify(customDiceRolls));
                renderCustomRolls();
                showNotification('âœ“ Custom roll deleted', 'info');
            }
        }
        
        // Combat Notes Tab Functions
        function saveCombatNotesTab() {
            const notes = document.getElementById('combat-notes-tab').value;
            localStorage.setItem('dnd-combat-notes-tab', notes);
            
            const timestamp = new Date().toLocaleTimeString();
            document.getElementById('notes-last-saved').textContent = `Last saved: ${timestamp}`;
        }
        
        function loadCombatNotesTab() {
            const notes = localStorage.getItem('dnd-combat-notes-tab') || '';
            const textarea = document.getElementById('combat-notes-tab');
            if (textarea) {
                textarea.value = notes;
            }
        }
        
        function clearCombatNotesTab() {
            if (confirm('Clear all notes? This cannot be undone!')) {
                document.getElementById('combat-notes-tab').value = '';
                localStorage.removeItem('dnd-combat-notes-tab');
                document.getElementById('notes-last-saved').textContent = 'Auto-saved';
                showNotification('âœ“ Notes cleared', 'info');
            }
        }
        
        function copyCombatNotesTab() {
            const notes = document.getElementById('combat-notes-tab');
            notes.select();
            document.execCommand('copy');
            showNotification('âœ“ Notes copied to clipboard!', 'success');
        }
        
        function exportCombatNotes() {
            const notes = document.getElementById('combat-notes-tab').value;
            if (!notes.trim()) {
                showNotification('âš ï¸ No notes to export!', 'error');
                return;
            }
            
            const blob = new Blob([notes], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `combat-notes-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('âœ“ Notes exported!', 'success');
        }
        
        // Quick Dice Panel Toggle (for Combat Tab)
        function toggleQuickDicePanel() {
            const panel = document.getElementById('floating-dice-roller');
            if (panel.style.display === 'none' || !panel.style.display) {
                panel.style.display = 'block';
                panel.classList.remove('collapsed');
                document.getElementById('dice-roller-content').style.display = 'block';
                document.getElementById('dice-roller-collapsed').style.display = 'none';
                showNotification('ðŸŽ² Quick Dice Roller opened', 'info');
            } else {
                panel.style.display = 'none';
                showNotification('ðŸŽ² Quick Dice Roller closed', 'info');
            }
        }
        
        // ==================== XP CALCULATOR ====================
        let xpLog = [];
        
        function calculateXPPerPlayer() {
            const totalXP = parseInt(document.getElementById('xp-total-input').value) || 0;
            const numPlayers = parseInt(document.getElementById('xp-players-input').value) || 1;
            const xpPerPlayer = Math.floor(totalXP / numPlayers);
            
            document.getElementById('xp-per-player').textContent = xpPerPlayer.toLocaleString();
        }
        
        // Update XP display whenever encounter changes
        function updateEncounterXP() {
            const totalXP = activeEncounter
                .filter(c => c.type === 'monster')
                .reduce((sum, monster) => sum + (monster.xp || 0), 0);
            
            document.getElementById('xp-total-input').value = totalXP;
            calculateXPPerPlayer();
        }
        
        function addXPToLog() {
            const totalXP = parseInt(document.getElementById('xp-total-input').value) || 0;
            const numPlayers = parseInt(document.getElementById('xp-players-input').value) || 1;
            const xpPerPlayer = Math.floor(totalXP / numPlayers);
            
            if (totalXP === 0) {
                showNotification('âš ï¸ No XP to add!', 'error');
                return;
            }
            
            const entry = {
                id: Date.now(),
                totalXP,
                numPlayers,
                xpPerPlayer,
                timestamp: new Date().toLocaleTimeString()
            };
            
            xpLog.unshift(entry);
            renderXPLog();
            
            showNotification(`âœ“ Added ${xpPerPlayer} XP per player to log!`, 'success');
        }
        
        function renderXPLog() {
            const logDiv = document.getElementById('xp-log');
            
            if (xpLog.length === 0) {
                logDiv.innerHTML = '';
                return;
            }
            
            logDiv.innerHTML = xpLog.map(entry => `
                <div class="p-2 rounded text-sm flex justify-between items-center" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
                    <div>
                        <span class="font-bold" style="color: var(--accent-gold);">${entry.xpPerPlayer} XP</span>
                        <span class="text-gray-400"> per player</span>
                        <span class="text-xs text-gray-500 ml-2">(${entry.totalXP} total Ã· ${entry.numPlayers})</span>
                    </div>
                    <button onclick="removeXPEntry(${entry.id})" class="text-red-400 hover:text-red-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function removeXPEntry(id) {
            xpLog = xpLog.filter(e => e.id !== id);
            renderXPLog();
        }
        
        // ==================== LOOT TRACKER ====================
        let lootLog = [];
        
        function addLootEntry() {
            const gold = parseInt(document.getElementById('loot-gold-input').value) || 0;
            const item = document.getElementById('loot-item-input').value.trim();
            const player = document.getElementById('loot-player-input').value.trim();
            
            if (gold === 0 && !item) {
                showNotification('âš ï¸ Enter gold amount or item name!', 'error');
                return;
            }
            
            const entry = {
                id: Date.now(),
                gold,
                item,
                player,
                timestamp: new Date().toLocaleTimeString()
            };
            
            lootLog.unshift(entry);
            renderLootLog();
            
            // Clear inputs
            document.getElementById('loot-gold-input').value = '0';
            document.getElementById('loot-item-input').value = '';
            document.getElementById('loot-player-input').value = '';
            
            let description = [];
            if (gold > 0) description.push(`${gold} gp`);
            if (item) description.push(item);
            
            showNotification(`âœ“ Added ${description.join(' & ')} to loot log!`, 'success');
        }
        
        function renderLootLog() {
            const logDiv = document.getElementById('loot-log');
            
            if (lootLog.length === 0) {
                logDiv.innerHTML = '<div class="text-center text-gray-400 italic text-sm">No loot recorded yet</div>';
                return;
            }
            
            logDiv.innerHTML = lootLog.map(entry => {
                let description = [];
                if (entry.gold > 0) description.push(`<span class="text-yellow-400">${entry.gold} gp</span>`);
                if (entry.item) description.push(`<span class="font-semibold">${entry.item}</span>`);
                
                return `
                    <div class="p-2 rounded text-sm" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div>${description.join(' & ')}</div>
                                ${entry.player ? `<div class="text-xs text-gray-400 mt-1"><i class="fas fa-user mr-1"></i>${entry.player}</div>` : ''}
                            </div>
                            <button onclick="removeLootEntry(${entry.id})" class="text-red-400 hover:text-red-300 ml-2">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function removeLootEntry(id) {
            lootLog = lootLog.filter(e => e.id !== id);
            renderLootLog();
        }
        
        function exportLootLog() {
            if (lootLog.length === 0) {
                showNotification('âš ï¸ No loot to export!', 'error');
                return;
            }
            
            let content = '=== LOOT LOG ===\n\n';
            
            let totalGold = 0;
            
            lootLog.reverse().forEach((entry, index) => {
                content += `${index + 1}. `;
                
                let items = [];
                if (entry.gold > 0) {
                    items.push(`${entry.gold} gp`);
                    totalGold += entry.gold;
                }
                if (entry.item) items.push(entry.item);
                
                content += items.join(' & ');
                
                if (entry.player) content += ` (${entry.player})`;
                content += `\n   Time: ${entry.timestamp}\n\n`;
            });
            
            content += `\n--- SUMMARY ---\n`;
            content += `Total Gold: ${totalGold} gp\n`;
            content += `Total Items: ${lootLog.filter(e => e.item).length}\n`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `loot-log-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('âœ“ Loot log exported!', 'success');
        }

        // ==================== LIVE INITIATIVE SHARING ====================
        // Firebase configuration (users will need to add their own)
       const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBgJG2-_3mBRouLz8GrYOp4smNd4UCncLQ",
            authDomain: "dnd-tracker-874c2.firebaseapp.com",
            databaseURL: "https://dnd-tracker-874c2-default-rtdb.firebaseio.com",
            projectId: "dnd-tracker-874c2",
            storageBucket: "dnd-tracker-874c2.firebasestorage.app",
            messagingSenderId: "630539015212",
            appId: "1:630539015212:web:823fc9a4e4823939516d89"
        };
        
        // Check if we're in a hosted environment (not file://)
        function checkHostedEnvironment() {
            isHostedEnvironment = window.location.protocol.startsWith('http');
            
            if (isHostedEnvironment) {
                // Show the sharing section
                const sharingSection = document.getElementById('live-sharing-section');
                if (sharingSection) {
                    sharingSection.style.display = 'block';
                }
                
                // Check if Firebase config is set up
                if (FIREBASE_CONFIG.apiKey === "YOUR_API_KEY_HERE") {
                    // Show instruction to configure Firebase
                    const statusDiv = document.getElementById('sharing-status');
                    if (statusDiv) {
                        statusDiv.innerHTML = '<span class="text-yellow-400">âš ï¸ Firebase not configured - See setup instructions</span>';
                    }
                }
            }
        }
        
        // Initialize Firebase (only if hosted and configured)
        async function initializeFirebase() {
            if (!isHostedEnvironment || FIREBASE_CONFIG.apiKey === "YOUR_API_KEY_HERE") {
                return false;
            }
            
            try {
                // Dynamically import Firebase (only when hosted)
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { getDatabase, ref, set, onDisconnect } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                
                const app = initializeApp(FIREBASE_CONFIG);
                firebaseDb = getDatabase(app);
                
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showNotification('âŒ Firebase initialization failed', 'error');
                return false;
            }
        }
        
        // Generate a random session ID
        function generateSessionId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        // Start live sharing
        async function startLiveSharing() {
            if (!isHostedEnvironment) {
                showNotification('âš ï¸ Live sharing only works when hosted (GitHub Pages or local server)', 'info');
                return;
            }
            
            if (FIREBASE_CONFIG.apiKey === "YOUR_API_KEY_HERE") {
                showNotification('âš ï¸ Please configure Firebase first - See documentation', 'error');
                return;
            }
            
            if (activeEncounter.length === 0) {
                showNotification('âš ï¸ Add combatants before starting live sharing', 'error');
                return;
            }
            
            // Initialize Firebase if needed
            if (!firebaseDb) {
                const initialized = await initializeFirebase();
                if (!initialized) return;
            }
            
            // Generate session ID
            currentSessionId = generateSessionId();
            liveSharingActive = true;
            
            // Update UI
            document.getElementById('sharing-status').innerHTML = 
                '<span class="text-green-400">ðŸŸ¢ Sharing Active</span>';
            document.getElementById('start-sharing-btn').disabled = true;
            document.getElementById('stop-sharing-btn').disabled = false;
            
            // Show share link
            const linkContainer = document.getElementById('share-link-container');
            const shareLink = document.getElementById('share-link');
            const baseUrl = window.location.origin + window.location.pathname.replace(/[^\/]*$/, '');
            const viewUrl = `${baseUrl}view.html?session=${currentSessionId}`;
            
            shareLink.value = viewUrl;
            linkContainer.style.display = 'block';
            
            // Push initial data
            await updateSharedInitiative();
            
            showNotification('âœ… Live sharing started! Copy and send link to players.', 'success');
        }
        
        // Stop live sharing
        async function stopLiveSharing() {
            if (!liveSharingActive) return;
            
            liveSharingActive = false;
            currentSessionId = null;
            
            // Update UI
            document.getElementById('sharing-status').innerHTML = 
                '<span class="text-gray-400">âšª Not Sharing</span>';
            document.getElementById('start-sharing-btn').disabled = false;
            document.getElementById('stop-sharing-btn').disabled = true;
            document.getElementById('share-link-container').style.display = 'none';
            
            showNotification('âœ“ Live sharing stopped', 'info');
        }
        
        // Update shared initiative data
        async function updateSharedInitiative() {
            if (!liveSharingActive || !firebaseDb || !currentSessionId) return;
            
            try {
                const { ref, set } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                
                const sessionData = {
                    round: currentRound,
                    currentTurn: currentTurnIndex,
                    combatants: activeEncounter.map((c, index) => ({
                        name: c.name,
                        initiative: c.initiative || 0,
                        hp: `${c.currentHp}/${c.maxHp}`,
                        ac: c.ac,
                        isCurrentTurn: index === currentTurnIndex,
                        type: c.type
                    })),
                    timestamp: Date.now()
                };
                
                await set(ref(firebaseDb, `sessions/${currentSessionId}`), sessionData);
            } catch (error) {
                console.error('Error updating shared initiative:', error);
            }
        }
        
        // Copy share link to clipboard
        function copyShareLink() {
            const shareLink = document.getElementById('share-link');
            shareLink.select();
            document.execCommand('copy');
            showNotification('âœ“ Link copied to clipboard!', 'success');
        }

        window.onload = () => {
            document.getElementById('json-upload').addEventListener('change', handleFileUpload);
            document.getElementById('encounter-upload').addEventListener('change', handleEncounterLoad);
            
            setupMultiSelect('creature-type');
            setupMultiSelect('cr-filter');
            
            // Restore saved player slots or create default ones
            let hasRestoredSlots = false;
            for (let i = 1; i <= 10; i++) {
                const savedData = localStorage.getItem(`player-slot-${i}`);
                if (savedData) {
                    addPlayerSlot(false);
                    hasRestoredSlots = true;
                }
            }
            
            // If no saved slots, create default ones
            if (!hasRestoredSlots) {
                const initialPlayerCount = parseInt(document.getElementById('players').value) || 4;
                for(let i = 0; i < initialPlayerCount; i++) {
                    addPlayerSlot(true);
                }
            }
            
            const savedTheme = localStorage.getItem('dnd-tracker-theme');
            if (savedTheme) {
                setTheme(savedTheme);
            }
            
            renderCombatTracker();
            renderMonsterSuggestions();
            updateDiceHistory();
            loadCombatNotes();
            
            // Load new tab content
            loadCombatNotesTab();
            renderCustomRolls();
            updateDiceHistoryTab();
            renderLootLog();
            
            // Add event listeners for XP calculator
            document.getElementById('xp-players-input').addEventListener('input', calculateXPPerPlayer);
            document.getElementById('xp-total-input').addEventListener('input', calculateXPPerPlayer);
            
            // Hide floating panels by default (will be toggled in Combat tab)
            document.getElementById('floating-dice-roller').style.display = 'none';
            document.getElementById('ai-assistant-panel').style.display = 'none';
            
            // Restore last active tab
            const savedTab = localStorage.getItem('dnd-current-tab') || 'setup';
            switchTab(savedTab);
            
            // Initialize draggable panels
            initializeDraggablePanels();
            loadPanelPositions();
            
            // Check if we're in a hosted environment (for live sharing)
            checkHostedEnvironment();
            
            showNotification('âœ“ Enhanced D&D Encounter Tracker Loaded!', 'success');
        };
        
        // Expose dice pool functions globally
        window.toggleDiceRoller = toggleDiceRoller;
        window.addDiceToRoll = addDiceToRoll;
        window.removeDiceFromPool = removeDiceFromPool;
        window.clearDicePool = clearDicePool;
        window.rollDicePool = rollDicePool;
        
        // Expose Combat Notes functions
        window.toggleAIAssistant = toggleAIAssistant;
        window.saveCombatNotes = saveCombatNotes;
        window.clearCombatNotes = clearCombatNotes;
        window.copyCombatNotes = copyCombatNotes;
        
        // Expose panel functions
        window.resetPanelPositions = resetPanelPositions;
        
        // Expose tab functions
        window.switchTab = switchTab;
        window.loadSavedEncounter = loadSavedEncounter;
        window.deleteSavedEncounter = deleteSavedEncounter;
        
        // Expose search function
        window.performMonsterSearch = performMonsterSearch;
        
        // Expose combat tracker functions
        window.clearEncounter = clearEncounter;
        window.removeCombatant = removeCombatant;
        
        // Expose new tab functions
        window.toggleQuickDicePanel = toggleQuickDicePanel;
        window.addDiceToRollTab = addDiceToRollTab;
        window.removeDiceFromPoolTab = removeDiceFromPoolTab;
        window.clearDicePoolTab = clearDicePoolTab;
        window.rollDicePoolTab = rollDicePoolTab;
        window.clearDiceHistoryTab = clearDiceHistoryTab;
        window.saveCustomRoll = saveCustomRoll;
        window.rollCustomDice = rollCustomDice;
        window.deleteCustomRoll = deleteCustomRoll;
        window.saveCombatNotesTab = saveCombatNotesTab;
        window.clearCombatNotesTab = clearCombatNotesTab;
        window.copyCombatNotesTab = copyCombatNotesTab;
        window.exportCombatNotes = exportCombatNotes;
        
        // Expose XP calculator functions
        window.calculateXPPerPlayer = calculateXPPerPlayer;
        window.addXPToLog = addXPToLog;
        window.removeXPEntry = removeXPEntry;
        
        // Expose loot tracker functions
        window.addLootEntry = addLootEntry;
        window.removeLootEntry = removeLootEntry;
        window.exportLootLog = exportLootLog;
        
        // Expose player slot functions
        window.savePlayerSlotData = savePlayerSlotData;
        window.removePlayerSlot = removePlayerSlot;
        window.addSinglePlayerToEncounter = addSinglePlayerToEncounter;
        
        // Expose live sharing functions
        window.startLiveSharing = startLiveSharing;
        window.stopLiveSharing = stopLiveSharing;
        window.copyShareLink = copyShareLink;
    </script>
</body>
</html>